<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Question Bank Generator</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Create, manage, and export medical question banks with AI-powered features. Perfect for medical education and exam preparation.">
    <meta name="keywords" content="medical questions, question bank, medical exam, AI questions, medical education, USMLE">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://qbgenerator.aimedipedia.com/qBankdbGenerator.html">
    <meta property="og:title" content="Medical Question Bank Generator - Create Medical Questions">
    <meta property="og:description" content="Advanced medical question bank creation tool with AI assistance, import/export capabilities, and comprehensive management features.">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://qbgenerator.aimedipedia.com/qBankdbGenerator.html">
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f9e0.png">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f9e0.png">
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #2c6fbb;
            --primary-dark: #1a5ca1;
            --secondary: #e8f1f9;
            --accent: #ff6b6b;
            --text: #333;
            --light-text: #666;
            --border: #ddd;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --ai-primary: #8e44ad;
            --ai-secondary: #f4e6fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 0.5rem 0 1.5rem 0;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        /* Navigation Styles */
        .main-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }
        
        .nav-brand .brand-link {
            color: white;
            text-decoration: none;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-brand .brand-link:hover {
            color: #ecf0f1;
        }
        
        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
        }
        
        .stats {
            display: flex;
            gap: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            flex-wrap: wrap;
            margin-top: 10px; 
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.85rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .ai-card {
            border-top: 4px solid var(--ai-primary);
        }
        
        .card-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--secondary);
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title .settings-icon {
            cursor: pointer;
            color: var(--primary);
            transition: transform 0.2s;
        }

        .card-title .settings-icon:hover {
            transform: rotate(30deg);
        }
        
        .ai-title {
            color: var(--ai-primary);
            border-bottom-color: var(--ai-secondary);
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--light-text);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .options-container {
            margin-top: 10px;
        }
        
        .option-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-input input[type="text"] {
            flex: 1;
            margin-right: 10px;
        }
        
        .option-input input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: #f1f1f1;
            color: var(--text);
        }
        
        .btn-secondary:hover {
            background: #e4e4e4;
        }
        
        .btn-update {
            background: linear-gradient(135deg, #ff9800, #f57c00) !important;
            border: none !important;
            color: white !important;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        
        #cancel-edit-btn {
            margin-left: 10px;
            background: #6c757d;
            border-color: #6c757d;
        }
        
        #cancel-edit-btn:hover {
            background: #5a6268;
            border-color: #545b62;
        }
        
        /* Highlight editing form */
        .form-editing {
            border: 3px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            background: linear-gradient(135deg, #fff3e0, #ffecb3);
            position: relative;
            margin: 20px 0;
            animation: highlightPulse 3s infinite;
        }
        
        @keyframes highlightPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px 5px rgba(255, 152, 0, 0.3);
                transform: scale(1.01);
            }
        }
        
        .form-editing::before {
            content: "✏️ EDITING MODE - SCROLL UP IF NEEDED";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            z-index: 1000;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(-5px);
            }
            60% {
                transform: translateX(-50%) translateY(-3px);
            }
        }
        
        .btn-danger {
            background: var(--accent);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5252;
        }
        
        .btn-ai {
            background: var(--ai-primary);
            color: white;
        }
        
        .btn-ai:hover {
            background: #7d3c98;
        }
        
        .btn-export {
            background: #28a745;
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-export:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-export i {
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }

        /* Specific export button colors */
        .btn-export[onclick*="exportToExcel"] {
            background: #107c41;
        }
        
        .btn-export[onclick*="exportToExcel"]:hover {
            background: #0e6b37;
            box-shadow: 0 4px 12px rgba(16, 124, 65, 0.3);
        }

        .btn-export[onclick*="exportToPDF"] {
            background: #dc3545;
        }
        
        .btn-export[onclick*="exportToPDF"]:hover {
            background: #c82333;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-export[onclick*="exportToWord"] {
            background: #2b579a;
        }
        
        .btn-export[onclick*="exportToWord"]:hover {
            background: #1e3f73;
            box-shadow: 0 4px 12px rgba(43, 87, 154, 0.3);
        }

        .btn-export[onclick*="exportToJSON"] {
            background: #6610f2;
        }
        
        .btn-export[onclick*="exportToJSON"]:hover {
            background: #520dc2;
            box-shadow: 0 4px 12px rgba(102, 16, 242, 0.3);
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .questions-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* Legacy styles removed - replaced with collapsible question styles */

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-category {
            background: #e8f1f9;
            color: var(--primary);
        }
        
        .badge-exam {
            background: #e6f7e6;
            color: #2e7d32;
        }
        
        .badge-topic {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .badge-ai {
            background: var(--ai-secondary);
            color: var(--ai-primary);
        }

        .dates-meta-inline {
            font-size: 0.75rem;
            color: var(--light-text);
        }
        

        /* Collapsible Question Styles */
        .question-item {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            overflow: hidden;
        }

        .question-header {
            padding: 15px;
            cursor: pointer;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-header:hover {
            background: var(--secondary);
        }

        .question-header.expanded {
            background: #e3eef9;
        }

        .question-summary {
            flex: 1;
        }

        .question-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }

        .question-preview {
            font-size: 0.9rem;
            color: var(--light-text);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .question-expand-icon {
            font-size: 1.2rem;
            color: var(--primary);
            transition: transform 0.3s ease;
            margin-left: 15px;
        }

        .question-expand-icon.expanded {
            transform: rotate(180deg);
        }

        .question-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .question-details.expanded {
            max-height: 1000px;
        }

        .question-content {
            padding: 20px;
        }

        .question-full-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: var(--text);
        }

        .question-options {
            margin: 15px 0;
        }

        .question-option {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 3px solid transparent;
        }

        .question-option.correct {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
            font-weight: 500;
        }

        .question-explanation {
            background: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            margin-top: 15px;
        }

        .question-explanation strong {
            color: #856404;
        }

        /* Discussion Area Styles */
        .question-discussion {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--ai-primary);
            margin-top: 15px;
            position: relative;
        }

        .question-discussion strong {
            color: var(--ai-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .discussion-content {
            color: #333;
            line-height: 1.7;
        }

        .discussion-content h3,
        .discussion-content h4,
        .discussion-content h5 {
            color: var(--ai-primary);
            margin: 1rem 0 0.5rem 0;
        }

        .discussion-content ul,
        .discussion-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .discussion-content li {
            margin-bottom: 0.25rem;
        }

        .discussion-content p {
            margin-bottom: 0.75rem;
        }

        .generate-discussion-btn {
            background: linear-gradient(135deg, var(--ai-primary), #9b59b6);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .generate-discussion-btn:hover {
            background: linear-gradient(135deg, #9b59b6, var(--ai-primary));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
        }

        .generate-discussion-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .discussion-loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--ai-primary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .discussion-loading.show {
            display: flex;
        }

        .discussion-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid var(--ai-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Discussion Result Styles */
        .ai-discussion-result {
            background: linear-gradient(135deg, #f8f9ff, #fff0f8);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--ai-primary);
            margin-top: 20px;
            position: relative;
        }

        .ai-discussion-result h4 {
            color: var(--ai-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .ai-discussion-result .discussion-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Creator/Username Styles */
        .question-creator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--light-text);
            margin-top: 8px;
        }

        .creator-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .creator-name {
            font-weight: 500;
        }

        .creator-ai {
            color: var(--ai-primary);
        }

        .creator-ai .creator-avatar {
            background: var(--ai-primary);
        }

        .question-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .search-box {
            display: flex;
            margin-bottom: 15px;
        }
        
        .search-box input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .search-box button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap; 
        }
        
        .filter-controls select, .filter-controls input {
            flex: 1;
            min-width: 150px; 
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-ai {
            background: var(--ai-primary);
        }
        
        .toast-export {
            background: #28a745;
        }
        
        .toast-error {
            background: var(--accent);
        }
        
        /* Rich text editor styles */
        .rich-text-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 8px;
            background: #f5f5f5;
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
        }
        
        .rich-text-toolbar button {
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .rich-text-toolbar button:hover {
            background: var(--secondary);
        }
        
        .rich-text-editor {
            min-height: 150px;
            border: 1px solid var(--border);
            border-radius: 0 0 6px 6px;
            padding: 12px;
            font-family: inherit;
        }
        
        .rich-text-editor:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Image upload styles */
        .image-upload {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            display: none;
            border-radius: 6px;
            border: 1px dashed var(--border);
        }

        .file-upload-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload-container input[type="file"] {
            flex: 1;
            min-width: 0;
        }
        
        /* AI Generation Styles */
        .ai-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .ai-option {
            background: var(--ai-secondary);
            border: 1px solid #d6b1e7;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .ai-option:hover {
            background: #e9c9f5;
        }
        
        .ai-option.selected {
            background: var(--ai-primary);
            color: white;
            border-color: var(--ai-primary);
        }
        
        .ai-loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .ai-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--ai-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-result {
            display: none;
            margin-top: 20px;
            border: 1px solid #d6b1e7;
            border-radius: 6px;
            padding: 15px;
            background: #fcfaff;
        }
        
        .ai-result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* AI API Notice */
        .ai-api-notice {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #856404;
            line-height: 1.4;
        }
        
        .ai-api-notice i.fas.fa-info-circle {
            color: #ffc107;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        
        .ai-api-notice i.fas.fa-cog {
            color: #856404;
            background: rgba(133, 100, 4, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        /* AI Button Group & Hint */
        .ai-button-group {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .ai-api-hint {
            color: #6c757d;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
            font-style: italic;
        }
        
        .ai-api-hint i.fas.fa-cog {
            color: #6c757d;
            font-size: 0.7rem;
        }
        
        /* Storage Warning */
        .storage-warning {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            border: 2px solid #fc8181;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            color: #742a2a;
            box-shadow: 0 2px 8px rgba(252, 129, 129, 0.2);
        }
        
        .storage-warning i.fas.fa-exclamation-triangle {
            color: #e53e3e;
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .warning-content {
            flex: 1;
        }
        
        .warning-content strong {
            display: block;
            color: #c53030;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .warning-content p {
            margin: 8px 0;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .warning-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .warning-content li {
            margin: 4px 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        /* Export buttons */
        .export-actions {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .export-actions::before {
            content: "📤";
            font-size: 1.2rem;
            margin-right: 0.5rem;
            align-self: center;
        }

        /* Dropdown Export/Import Styles */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            background: linear-gradient(135deg, #2c6fbb, #1a5ca1);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dropdown-btn:hover {
            background: linear-gradient(135deg, #1a5ca1, #2c6fbb);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(44, 111, 187, 0.3);
        }

        .dropdown-btn i.fa-chevron-down {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .dropdown-btn.active i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 1px solid #e0e0e0;
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            border-bottom: 1px solid #f5f5f5;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #2c6fbb;
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
        }

        /* Export dropdown items - specific colors */
        .dropdown-item.export-excel:hover {
            background: #e8f5e9;
            color: #107c41;
        }

        .dropdown-item.export-pdf:hover {
            background: #ffeaea;
            color: #dc3545;
        }

        .dropdown-item.export-markdown:hover {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .dropdown-item.export-json:hover {
            background: #f3e5f5;
            color: #6610f2;
        }

        /* Import dropdown button */
        .dropdown-btn.import-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .dropdown-btn.import-btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .dropdown-item.import-json:hover {
            background: #f3e5f5;
            color: #6610f2;
        }

        .dropdown-item.import-excel:hover {
            background: #e8f5e9;
            color: #107c41;
        }

        .dropdown-item.sample-download:hover {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Select2 customization */
        .select2-container--default .select2-selection--single {
            height: 42px;
            padding: 8px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }
        
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--primary);
        }
        
        /* AI Settings Panel */
        #ai-settings-panel {
            display: none;
        }

        #ai-settings-panel.show {
            display: block;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            padding: 32px 32px 24px 32px;
            min-width: 340px;
            max-width: 95vw;
            position: relative;
            animation: modalIn 0.2s cubic-bezier(.4,2,.6,1) both;
        }
        
        .modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #888;
            cursor: pointer;
        }
        
        @keyframes modalIn {
            from { transform: translateY(-40px) scale(0.95); opacity: 0; }
            to { transform: none; opacity: 1; }
        }
        
        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .user-icon-container {
            position: relative;
            cursor: pointer;
        }
        
        .user-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-icon:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .user-icon.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }
        
        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .profile-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }
        
        .profile-header {
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            margin: 0 auto 1rem auto;
            border: 3px solid #f8f9fa;
        }
        
        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }
        
        .profile-email {
            font-size: 0.9rem;
            color: var(--light-text);
        }
        
        .profile-actions {
            padding: 1rem;
        }
        
        .profile-btn {
            width: 100%;
            background: none;
            border: none;
            padding: 0.75rem 1rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .profile-btn:hover {
            background: #f8f9fa;
            color: var(--primary);
        }
        
        .profile-btn.logout {
            color: var(--accent);
            border-top: 1px solid #f0f0f0;
            margin-top: 0.5rem;
            padding-top: 1rem;
        }
        
        .profile-btn.logout:hover {
            background: rgba(255, 107, 107, 0.1);
        }
        
        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .profile-modal.show {
            display: flex;
        }
        
        .profile-modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
            padding: 0.25rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
            color: var(--text);
        }
        
        /* Profile Modal Info Styles */
        .profile-info-section {
            margin-top: 1rem;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row i {
            width: 20px;
            color: var(--primary);
        }
        
        .info-row div {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .info-row strong {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 0.25rem;
        }
        
        .info-row span {
            font-size: 0.85rem;
            color: var(--light-text);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .user-email {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .user-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .user-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .guest-notice {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .guest-notice i {
            color: #ff9800;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            header h1 {
                font-size: 1.2rem;
            }
            
            .main-nav {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }

            .stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 5px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }
            
            .ai-options {
                grid-template-columns: 1fr;
            }
            
            .export-actions {
                flex-direction: column;
                gap: 12px;
            }

            .dropdown-container {
                width: 100%;
            }

            .dropdown-btn {
                width: 100%;
                justify-content: center;
            }

            .dropdown-menu {
                width: 100%;
                left: 0;
                right: 0;
            }

            .btn, input, select, textarea {
                font-size: 0.9rem;
            }

            .card {
                padding: 1rem;
            }

            .card-title {
                font-size: 1.1rem;
            }
        }
        
        /* Footer Styles */
        .app-footer {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 2rem 0 1rem;
            margin-top: 4rem;
            border-top: 3px solid var(--primary);
        }
        
        .app-footer .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .app-footer .footer-section h4 {
            color: #ecf0f1;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .app-footer .footer-brand h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.4rem;
        }
        
        .app-footer .footer-brand p {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .app-footer .footer-links {
            list-style: none;
            padding: 0;
        }
        
        .app-footer .footer-links li {
            margin-bottom: 0.5rem;
        }
        
        .app-footer .footer-links a {
            color: #bdc3c7;
            text-decoration: none;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .app-footer .footer-links a:hover {
            color: var(--primary);
        }
        
        .app-footer .footer-links span {
            color: #95a5a6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .app-footer .social-links {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .app-footer .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .app-footer .social-links a:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }
        
        .app-footer .footer-domain {
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .app-footer .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .app-footer .footer-info p {
            margin: 0;
            opacity: 0.8;
        }
        
        .app-footer .footer-subtitle {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        .app-footer .footer-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .app-footer .footer-badges .badge {
            background: rgba(44, 111, 187, 0.2);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            border: 1px solid rgba(44, 111, 187, 0.3);
        }
        
        @media (max-width: 768px) {
            .app-footer .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 2rem;
            }
            
            .app-footer .footer-bottom {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .app-footer .social-links {
                justify-content: center;
            }
            
            .storage-warning {
                flex-direction: column;
                text-align: center;
                padding: 12px 16px;
            }
            
            .storage-warning i.fas.fa-exclamation-triangle {
                align-self: center;
                margin-bottom: 8px;
            }
            
            /* Mobile user profile styles */
            .profile-dropdown {
                right: -10px;
                min-width: 260px;
            }
            
            .profile-modal-content {
                margin: 1rem;
                max-width: none;
                width: calc(100% - 2rem);
            }
            
            .nav-links {
                gap: 1rem;
            }
            
            .user-icon {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <!-- Navigation Bar -->
            <nav class="main-nav">
                <div class="nav-brand">
                    <a href="index.html" class="brand-link">
                        <i class="fas fa-brain"></i> QBank Generator
                    </a>
                </div>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i> Home
                    </a>
                    <a href="auth.html" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i> Auth
                    </a>
                    <a href="#question-form" class="nav-link">
                        <i class="fas fa-plus"></i> Add Question
                    </a>
                    <a href="#questions-list" class="nav-link">
                        <i class="fas fa-list"></i> Questions
                    </a>
                </div>
            </nav>
            
            <div class="header-content">
                <div>
                    <h1>📊 Medical Question Bank Generator</h1>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="total-questions">0</div>
                            <div class="stat-label">Total Questions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ai-questions">0</div>
                            <div class="stat-label">AI Generated</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="internal-medicine">0</div>
                            <div class="stat-label">Internal Medicine</div>
                        </div>
                    </div>
                </div>
                
                <!-- User Profile Section -->
                <div id="userProfileSection" class="user-profile" style="display: none;">
                    <div class="user-icon-container">
                        <div class="user-icon" id="userIcon">
                            <span id="userInitials">U</span>
                        </div>
                        
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-header">
                                <div class="profile-avatar" id="profileAvatar">U</div>
                                <div class="profile-name" id="profileName">User Name</div>
                                <div class="profile-email" id="profileEmail">user@example.com</div>
                            </div>
                            <div class="profile-actions">
                                <button class="profile-btn" id="viewProfileBtn">
                                    <i class="fas fa-user"></i> View Profile
                                </button>
                                <button class="profile-btn logout" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Guest Notice -->
                <div id="guestNotice" class="guest-notice" style="display: none;">
                    <i class="fas fa-user-clock"></i>
                    <span>Guest Mode - <a href="auth.html" style="color: #333; font-weight: bold;">Login</a> to save progress</span>
                </div>
                
                <!-- Login Button (when not authenticated) -->
                <div id="loginSection" class="user-actions" style="display: none;">
                    <a href="auth.html" class="user-btn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                    <a href="auth.html" class="user-btn">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-content">
            <button class="modal-close" id="modalClose">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="profile-header">
                <div class="profile-avatar" id="modalAvatar">U</div>
                <div class="profile-name" id="modalName">User Name</div>
                <div class="profile-email" id="modalEmail">user@example.com</div>
            </div>
            
            <div class="profile-actions">
                <div class="profile-info-section">
                    <h3 style="margin-bottom: 1rem; color: var(--text);">Profile Information</h3>
                    
                    <div class="info-row">
                        <i class="fas fa-user"></i>
                        <div>
                            <strong>Display Name</strong>
                            <span id="modalDisplayName">-</span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <strong>Email</strong>
                            <span id="modalUserEmail">-</span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <i class="fas fa-calendar-alt"></i>
                        <div>
                            <strong>Member Since</strong>
                            <span id="modalJoinDate">-</span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <i class="fas fa-sign-in-alt"></i>
                        <div>
                            <strong>Login Method</strong>
                            <span id="modalProvider">-</span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <i class="fas fa-question-circle"></i>
                        <div>
                            <strong>Questions Created</strong>
                            <span id="modalQuestionsCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="main-content">
            <div class="left-panel">
                <div class="card">
                    <h2 class="card-title">Add New Question (Manual)</h2>
                    <form id="question-form">
                        <div class="form-group">
                            <label for="exam-name">Exam Name</label>
                            <input type="text" id="exam-name" placeholder="e.g., USMLE Step 1, USMLE Step 2, SMLE, AMC" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subject">Subject</label>
                            <select id="subject" class="searchable-select" required>
                                <option value="">Select a subject</option>
                                <option value="Internal Medicine">Internal Medicine</option>
                                <option value="Surgery">Surgery</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                <option value="Psychiatry">Psychiatry</option>
                                <option value="Radiology">Radiology</option>
                                <option value="Pathology">Pathology</option>
                                <option value="Pharmacology">Pharmacology</option>
                                <option value="Microbiology">Microbiology</option>
                                <option value="Anatomy">Anatomy</option>
                                <option value="Physiology">Physiology</option>
                                <option value="Biochemistry">Biochemistry</option>
                                <option value="Immunology">Immunology</option>
                                <option value="Cardiology">Cardiology</option>
                                <option value="Neurology">Neurology</option>
                                <option value="Endocrinology">Endocrinology</option>
                                <option value="Gastroenterology">Gastroenterology</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="topic">Topic</label>
                            <input type="text" id="topic" placeholder="Enter topic (e.g., Diabetes management, Heart anatomy)" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="question">Question</label>
                            <div class="rich-text-toolbar">
                                <button type="button" onclick="formatQuestionText('bold')"><strong>B</strong></button>
                                <button type="button" onclick="formatQuestionText('italic')"><em>I</em></button>
                                <button type="button" onclick="formatQuestionText('underline')"><u>U</u></button>
                                <button type="button" onclick="formatQuestionText('insertUnorderedList')">• List</button>
                                <button type="button" onclick="formatQuestionText('insertOrderedList')">1. List</button>
                                <button type="button" onclick="insertQuestionImage()"><i class='fas fa-image'></i> Image</button>
                                <input type="file" id="question-image-insert" accept="image/*" style="display:none" />
                            </div>
                            <div id="question-rich" class="rich-text-editor" contenteditable="true" placeholder="Enter the question..."></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Attach Image (Optional)</label>
                            <div class="image-upload">
                                <input type="file" id="question-image" accept="image/*">
                                <img id="image-preview" class="image-preview" alt="Image preview">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Options</label>
                            <div class="options-container" id="options-container">
                                <!-- Options will be added by JavaScript -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addOption()" style="margin-top: 10px;">+ Add Option</button>
                        </div>
                        
                        <div class="form-group">
                            <label for="explanation">Explanation</label>
                            <div class="rich-text-toolbar">
                                <button type="button" onclick="formatText('bold')"><strong>B</strong></button>
                                <button type="button" onclick="formatText('italic')"><em>I</em></button>
                                <button type="button" onclick="formatText('underline')"><u>U</u></button>
                                <button type="button" onclick="formatText('insertUnorderedList')">• List</button>
                                <button type="button" onclick="formatText('insertOrderedList')">1. List</button>
                                <button type="button" onclick="insertImage()"><i class="fas fa-image"></i> Image</button>
                            </div>
                            <div id="explanation" class="rich-text-editor" contenteditable="true"></div>
                            <div class="ai-button-group">
                                <button type="button" class="btn btn-ai" id="generate-explanation-btn">Generate AI Explanation</button>
                                <small class="ai-api-hint">
                                    <i class="fas fa-cog"></i> API required - click settings icon above
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="discussion">Discussion</label>
                            <div class="rich-text-toolbar">
                                <button type="button" onclick="formatDiscussion('bold')"><strong>B</strong></button>
                                <button type="button" onclick="formatDiscussion('italic')"><em>I</em></button>
                                <button type="button" onclick="formatDiscussion('underline')"><u>U</u></button>
                                <button type="button" onclick="formatDiscussion('insertUnorderedList')">• List</button>
                                <button type="button" onclick="formatDiscussion('insertOrderedList')">1. List</button>
                                <button type="button" onclick="insertDiscussionImage()"><i class="fas fa-image"></i> Image</button>
                            </div>
                            <div id="discussion" class="rich-text-editor" contenteditable="true" placeholder="Enter detailed discussion about the topic..."></div>
                            <div class="ai-button-group">
                                <button type="button" class="generate-discussion-btn" id="generate-discussion-btn">
                                    <i class="fas fa-brain"></i> Generate AI Discussion
                                </button>
                                <div class="discussion-loading" id="discussion-loading">
                                    <div class="discussion-spinner"></div>
                                    <span>Generating discussion...</span>
                                </div>
                                <small class="ai-api-hint">
                                    <i class="fas fa-cog"></i> API required - click settings icon above
                                </small>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button type="submit" class="btn btn-primary">Save Question</button>
                            <button type="reset" class="btn btn-secondary" id="reset-btn">Clear Form</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="middle-panel">
                <div class="card ai-card">
                    <h2 class="card-title ai-title">
                        AI Question Generation <i class="fas fa-robot"></i>
                        <i class="fas fa-cog settings-icon" onclick="toggleAiSettings()"></i>
                    </h2>
                    
                    <div class="ai-api-notice">
                        <i class="fas fa-info-circle"></i>
                        <span>To use AI generation, you need to configure your own API key. Click the <i class="fas fa-cog"></i> settings icon above to set up your API.</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-exam-name">Exam Name</label>
                        <input type="text" id="ai-exam-name" placeholder="e.g., USMLE Step 1, USMLE Step 2, SMLE, AMC" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-subject">Subject Area</label>
                        <select id="ai-subject" class="searchable-select" required>
                            <option value="">Select a subject</option>
                            <option value="Internal Medicine">Internal Medicine</option>
                            <option value="Surgery">Surgery</option>
                            <option value="Pediatrics">Pediatrics</option>
                            <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                            <option value="Psychiatry">Psychiatry</option>
                            <option value="Radiology">Radiology</option>
                            <option value="Pathology">Pathology</option>
                            <option value="Pharmacology">Pharmacology</option>
                            <option value="Microbiology">Microbiology</option>
                            <option value="Anatomy">Anatomy</option>
                            <option value="Physiology">Physiology</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="ai-topic">Topic or Concept</label>
                        <input type="text" id="ai-topic" placeholder="e.g., Diabetes management, Heart anatomy" required>
                    </div>

                    <div class="form-group">
                        <label for="ai-context">Additional Context (Optional)</label>
                        <textarea id="ai-context" placeholder="Provide additional details, clinical vignettes, or specific requirements here."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="ai-file">Upload Document/Image (Optional)</label>
                        <div class="file-upload-container">
                            <input type="file" id="ai-file">
                            <button type="button" class="btn btn-secondary" id="ai-file-btn" onclick="processAiFile()">Process File</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-url">Chat with URL (Optional)</label>
                        <div class="url-input-container">
                            <input type="text" id="ai-url" placeholder="Enter a URL to summarize and use as context">
                            <button type="button" class="btn btn-secondary" id="ai-url-btn" onclick="processAiUrl()">Process URL</button>
                        </div>
                    </div>
                    
                    <button class="btn btn-ai" onclick="generateQuestion()" style="width: 100%;">
                        <i class="fas fa-magic"></i> Generate Question
                    </button>
                    
                    <div class="ai-loading" id="ai-loading">
                        <div class="spinner"></div>
                        <p>Generating question with AI...</p>
                    </div>
                    
                    <div class="ai-result" id="ai-result">
                        <h4>AI-Generated Question</h4>
                        <div id="ai-question-text"></div>
                        <div class="ai-result-actions">
                            <button class="btn btn-ai" onclick="useAiQuestion()">
                                <i class="fas fa-save"></i> Use This Question
                            </button>
                            <button class="btn btn-secondary" onclick="regenerateQuestion()">
                                <i class="fas fa-redo"></i> Regenerate
                            </button>
                        </div>
                    </div>
                    
                    <div class="ai-discussion-result" id="ai-discussion-result" style="display: none;">
                        <h4><i class="fas fa-comments"></i> AI-Generated Discussion</h4>
                        <div id="ai-discussion-text" class="discussion-content"></div>
                        <div class="ai-result-actions">
                            <button class="btn btn-ai" onclick="useAiDiscussion()">
                                <i class="fas fa-save"></i> Use This Discussion
                            </button>
                            <button class="btn btn-secondary" onclick="regenerateAiDiscussion()">
                                <i class="fas fa-redo"></i> Regenerate Discussion
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="card">
                    <h2 class="card-title">Question Bank</h2>
                    
                    <div class="storage-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="warning-content">
                            <strong>⚠️ Important: Data Storage Notice</strong>
                            <p>Your questions are stored locally in your browser only. <strong>They are NOT stored in the cloud.</strong> 
                            You may lose your questions when:</p>
                            <ul>
                                <li>Clearing browser cache/cookies</li>
                                <li>Using incognito/private browsing mode</li>
                                <li>Switching devices or browsers</li>
                                <li>Browser updates or crashes</li>
                            </ul>
                            <p><strong>📥 Recommended:</strong> Export your questions regularly using the buttons below to prevent data loss!</p>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search questions...">
                        <button class="btn btn-primary" onclick="searchQuestions()">Search</button>
                    </div>
                    
                    <div class="filter-controls">
                        <select id="filter-subject" class="searchable-select">
                            <option value="">All Subjects</option>
                            <option value="Internal Medicine">Internal Medicine</option>
                            <option value="Surgery">Surgery</option>
                            <option value="Pediatrics">Pediatrics</option>
                            <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                            <option value="Psychiatry">Psychiatry</option>
                            <option value="Radiology">Radiology</option>
                            <option value="Pathology">Pathology</option>
                            <option value="Pharmacology">Pharmacology</option>
                            <option value="Microbiology">Microbiology</option>
                            <option value="Anatomy">Anatomy</option>
                            <option value="Physiology">Physiology</option>
                        </select>
                        
                        <select id="filter-exam" class="searchable-select">
                            <option value="">All Exams</option>
                            <option value="USMLE Step 1">USMLE Step 1</option>
                            <option value="USMLE Step 2">USMLE Step 2</option>
                            <option value="USMLE Step 3">USMLE Step 3</option>
                            <option value="MCAT">MCAT</option>
                            <option value="NCLEX-RN">NCLEX-RN</option>
                            <option value="NCLEX-PN">NCLEX-PN</option>
                        </select>
                    </div>
                    
                    <div class="filter-controls">
                        <input type="text" id="filter-topic" placeholder="Filter by topic...">
                        <select id="filter-source">
                            <option value="">All Sources</option>
                            <option value="manual">Manual Entry</option>
                            <option value="ai">AI Generated</option>
                        </select>
                    </div>
                    
                    <div class="export-actions">
                        <!-- Export Dropdown -->
                        <div class="dropdown-container">
                            <button class="dropdown-btn" id="exportDropdownBtn" onclick="toggleDropdown('exportDropdown')">
                                <i class="fas fa-download"></i>
                                Export Options
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu" id="exportDropdown">
                                <a href="#" class="dropdown-item export-excel" onclick="exportToExcel(); closeDropdown('exportDropdown')">
                                    <i class="fas fa-file-excel"></i>
                                    Export to Excel (.xlsx)
                                </a>
                                <a href="#" class="dropdown-item export-pdf" onclick="exportToPDF(); closeDropdown('exportDropdown')">
                                    <i class="fas fa-file-pdf"></i>
                                    Export to PDF (.pdf)
                                </a>
                                <a href="#" class="dropdown-item export-markdown" onclick="exportToMarkdown(); closeDropdown('exportDropdown')">
                                    <i class="fas fa-file-alt"></i>
                                    Export to Markdown (.md)
                                </a>
                                <a href="#" class="dropdown-item export-json" onclick="exportToJSON(); closeDropdown('exportDropdown')">
                                    <i class="fas fa-file-code"></i>
                                    Export as JSON (.json)
                                </a>
                            </div>
                        </div>

                        <!-- Import Dropdown -->
                        <div class="dropdown-container">
                            <button class="dropdown-btn import-btn" id="importDropdownBtn" onclick="toggleDropdown('importDropdown')">
                                <i class="fas fa-upload"></i>
                                Import Options
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu" id="importDropdown">
                                <a href="#" class="dropdown-item import-json" onclick="document.getElementById('import-json-input').click(); closeDropdown('importDropdown')">
                                    <i class="fas fa-file-code"></i>
                                    Import JSON File
                                </a>
                                <a href="#" class="dropdown-item import-excel" onclick="document.getElementById('import-excel-input').click(); closeDropdown('importDropdown')">
                                    <i class="fas fa-file-excel"></i>
                                    Import Excel File
                                </a>
                                <a href="sample_import_questions.csv" download class="dropdown-item sample-download" onclick="closeDropdown('importDropdown')">
                                    <i class="fas fa-download"></i>
                                    Download Sample CSV
                                </a>
                            </div>
                        </div>

                        <!-- Hidden file inputs -->
                        <input type="file" id="import-json-input" accept="application/json" style="display:none" />
                        <input type="file" id="import-excel-input" accept=".xlsx,.xls" style="display:none" />
                    </div>
                    
                    <div class="questions-list" id="questions-list">
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">Question saved successfully!</div>
    <div class="toast toast-ai" id="toast-ai">AI question generated successfully!</div>
    <div class="toast toast-export" id="toast-export">Export completed successfully!</div>
    <div class="toast toast-error" id="toast-error">An error occurred.</div>

    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">

    <!-- Modal for AI Settings -->
    <div id="ai-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="toggleAiSettings()">&times;</button>
            <h2 class="card-title">AI Configuration</h2>
            <div class="form-group">
                <label for="api-key">API Key</label>
                <input type="password" id="api-key" placeholder="Enter your API key">
            </div>
            <div class="form-group">
                <label for="ai-model">AI Model</label>
                <select id="ai-model">
                    <optgroup label="OpenAI">
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </optgroup>
                    <optgroup label="Google">
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                        <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                    </optgroup>
                    <optgroup label="DeepSeek">
                        <option value="deepseek-chat">DeepSeek Chat</option>
                    </optgroup>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="saveApiSettings()" style="width: 100%;">
                <i class="fas fa-save"></i> Save API Settings
            </button>
            <div class="form-group" style="margin-top: 20px;">
                <label for="api-status">API Status</label>
                <div id="api-status" style="padding: 10px; border-radius: 6px; background: #f0f0f0;">
                    Not configured
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // --- Question Bank App Main Script ---
        // This script handles all core logic for the Medical Question Bank Generator web app.
        // Features: Add, edit, delete, import/export, AI generation, image insertion, and responsive UI.

        // Initialize the question bank from localStorage or as an empty array
        let questionBank = []; // Initialize as empty, will be loaded after auth
        let editingId = null; // Track which question is being edited
        let currentAiQuestion = null; // Store the current AI-generated question
        let openAiApiKey = localStorage.getItem('openaiApiKey') || '';
        let openAiModel = localStorage.getItem('openaiModel') || 'gpt-3.5-turbo';
        let aiFileContent = null; // For file/URL context in AI generation
        
        // DOM elements
        const questionForm = document.getElementById('question-form');
        const questionsList = document.getElementById('questions-list');
        const toast = document.getElementById('toast');
        const toastAi = document.getElementById('toast-ai');
        const toastExport = document.getElementById('toast-export');
        const toastError = document.getElementById('toast-error');
        const imageInput = document.getElementById('question-image');
        const imagePreview = document.getElementById('image-preview');
        const aiLoading = document.getElementById('ai-loading');
        const aiResult = document.getElementById('ai-result');
        const aiQuestionText = document.getElementById('ai-question-text');
        const apiKeyInput = document.getElementById('api-key');
        const aiModelSelect = document.getElementById('ai-model');
        const apiStatus = document.getElementById('api-status');
        const imageUploadInput = document.getElementById('image-upload-input');
        const aiSettingsModal = document.getElementById('ai-settings-modal');

        // --- Utility Functions ---
        // Show a toast notification
        function showToast(message, type) {
            const currentToast = document.querySelector('.toast.show');
            if (currentToast) {
                currentToast.classList.remove('show');
            }
            let selectedToast = toast;
            if (type === 'toast-ai') selectedToast = toastAi;
            if (type === 'toast-export') selectedToast = toastExport;
            if (type === 'toast-error') selectedToast = toastError;

            selectedToast.textContent = message;
            selectedToast.classList.add('show');
            setTimeout(() => {
                selectedToast.classList.remove('show');
            }, 3000);
        }

        // Save API settings to localStorage
        function saveApiSettings() {
            openAiApiKey = apiKeyInput.value.trim();
            openAiModel = aiModelSelect.value;
            localStorage.setItem('openaiApiKey', openAiApiKey);
            localStorage.setItem('openaiModel', openAiModel);
            updateApiStatus('API settings saved. Please note the key should match the selected model.', 'success');
        }

        // Toggle the AI settings modal
        function toggleAiSettings() {
            const modal = document.getElementById('ai-settings-modal');
            modal.classList.toggle('show');
        }

        // --- Question CRUD Functions ---
        // Save the question bank to localStorage
        function saveQuestionBank() {
            const storageKey = getUserStorageKey('medicalQuestionBank');
            localStorage.setItem(storageKey, JSON.stringify(questionBank));
        }

        // Get creator information for display
        function getCreatorInfo(question) {
            if (question.source === 'ai') {
                return {
                    name: 'AI Assistant',
                    avatar: '🤖'
                };
            }
            
            // For manual questions, try to get user info
            if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                const user = firebase.auth().currentUser;
                const displayName = user.displayName || user.email?.split('@')[0] || 'User';
                const avatar = displayName.charAt(0).toUpperCase();
                return {
                    name: displayName,
                    avatar: avatar
                };
            }
            
            // Fallback for guest users or when Firebase is not available
            return {
                name: question.createdBy || 'Anonymous User',
                avatar: (question.createdBy || 'U').charAt(0).toUpperCase()
            };
        }

        // Render the list of questions in the Question Bank
        function renderQuestions() {
            questionsList.innerHTML = '';
            const filterSubject = $('#filter-subject').val();
            const filterExam = $('#filter-exam').val();
            const filterTopic = document.getElementById('filter-topic').value.toLowerCase();
            const filterSource = document.getElementById('filter-source').value;

            const filteredQuestions = questionBank.filter(q => {
                const matchesSubject = !filterSubject || q.subject === filterSubject;
                const matchesExam = !filterExam || q.examName === filterExam;
                const matchesTopic = !filterTopic || (q.topic && q.topic.toLowerCase().includes(filterTopic));
                const matchesSource = !filterSource || q.source === filterSource;
                return matchesSubject && matchesExam && matchesTopic && matchesSource;
            });
            
            if (filteredQuestions.length === 0) {
                questionsList.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--light-text);">No questions found.</div>`;
                return;
            }

            filteredQuestions.forEach((q, index) => {
                const questionItem = document.createElement('div');
                questionItem.classList.add('question-item');
                questionItem.setAttribute('data-id', q.id);
                
                // Get creator information
                const creatorInfo = getCreatorInfo(q);
                
                // Create question preview (first 80 characters for more compact view)
                const questionPreview = q.question.replace(/<[^>]*>/g, '').substring(0, 80) + '...';
                
                questionItem.innerHTML = `
                    <div class="question-content" onclick="editQuestion('${q.id}')">
                        <div class="question-summary">
                            <div class="question-title">Q${index + 1}. ${questionPreview}</div>
                            <div class="question-meta">
                                <span class="badge badge-exam">${q.examName}</span>
                                <span class="badge badge-category">${q.subject}</span>
                                <span class="badge badge-topic">${q.topic}</span>
                                ${q.source === 'ai' ? `<span class="badge badge-ai">AI Generated</span>` : ''}
                            </div>
                            <div class="question-creator ${q.source === 'ai' ? 'creator-ai' : ''}">
                                <div class="creator-avatar">${creatorInfo.avatar}</div>
                                <span class="creator-name">Created by ${creatorInfo.name}</span>
                                <span class="dates-meta-inline">• ${q.createdAt || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="question-actions-inline">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editQuestion('${q.id}')" title="Edit Question">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                questionsList.appendChild(questionItem);
            });
        }

        // Edit a question and ensure proper scroll to top
        function scrollToEditForm(id) {
            // First load the question for editing
            editQuestion(id);
            
            // Then do a more aggressive scroll to top
            setTimeout(() => {
                // Try multiple scroll methods for better compatibility
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Backup scroll method
                setTimeout(() => {
                    document.body.scrollTop = 0; // For Safari
                    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
                }, 500);
                
                // Show additional guidance
                showToast('✏️ EDITING MODE: Form is now ready at the top!', 'toast-ai');
            }, 200);
        }

        // Edit a question (populate the form for editing)
        function editQuestion(id) {
            console.log('Editing question with ID:', id, 'Type:', typeof id);
            console.log('Current question bank:', questionBank);
            
            // Convert ID to number if it's a string (from HTML template)
            const numericId = typeof id === 'string' ? parseInt(id, 10) : id;
            console.log('Converted ID:', numericId, 'Type:', typeof numericId);
            
            editingId = numericId;
            const question = questionBank.find(q => {
                console.log('Comparing question ID:', q.id, 'Type:', typeof q.id, 'with search ID:', numericId);
                return q.id === numericId;
            });
            
            if (!question) {
                console.error('Question not found with ID:', id);
                showToast('❌ Question not found!', 'toast-error');
                return;
            }
            
            console.log('Found question:', question);

            // Add visual editing mode to form
            const formCard = document.querySelector('.card:has(#question-form)');
            if (formCard) {
                formCard.classList.add('form-editing');
            }

            // Clear and populate form fields
            document.getElementById('exam-name').value = question.examName || '';
            
            // Handle subject dropdown with Select2
            document.getElementById('subject').value = question.subject || '';
            if (typeof $ !== 'undefined' && $('#subject').hasClass('select2-hidden-accessible')) {
                $('#subject').trigger('change');
            }
            
            document.getElementById('topic').value = question.topic || '';
            document.getElementById('question-rich').innerHTML = question.question || '';

            // Clear and rebuild options
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            if (question.options && question.options.length > 0) {
                question.options.forEach((opt, index) => {
                    const optionHtml = createOptionHtml(opt);
                    optionsContainer.appendChild(optionHtml);
                    if (String.fromCharCode(65 + index) === question.correctAnswer) {
                        optionHtml.querySelector('input[type="radio"]').checked = true;
                    }
                });
            } else {
                // Add default options if none exist
                addOption();
                addOption();
            }

            // Populate rich text fields
            document.getElementById('explanation').innerHTML = question.explanation || '';
            document.getElementById('discussion').innerHTML = question.discussion || '';
            
            // Handle image
            if (question.image) {
                imagePreview.src = question.image;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            // Update form submit button
            const submitButton = document.querySelector('#question-form button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Update Question';
                submitButton.classList.add('btn-update');
            }
            
            // Add a cancel edit button if it doesn't exist
            let cancelButton = document.getElementById('cancel-edit-btn');
            if (!cancelButton) {
                cancelButton = document.createElement('button');
                cancelButton.type = 'button';
                cancelButton.id = 'cancel-edit-btn';
                cancelButton.className = 'btn btn-secondary';
                cancelButton.innerHTML = '<i class="fas fa-times"></i> Cancel Edit';
                cancelButton.onclick = cancelEdit;
                
                const actionsDiv = submitButton.parentNode;
                actionsDiv.insertBefore(cancelButton, submitButton.nextSibling);
            }
            cancelButton.style.display = 'inline-block';
            
            // Enhanced scroll to form with multiple fallbacks
            setTimeout(() => {
                // Method 1: Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Method 2: Scroll to form element specifically
                const formElement = document.getElementById('question-form');
                if (formElement) {
                    formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Method 3: Focus on first input (this also ensures visibility)
                setTimeout(() => {
                    const examNameInput = document.getElementById('exam-name');
                    if (examNameInput) {
                        examNameInput.focus();
                        examNameInput.select(); // Also select the text for easier editing
                    }
                }, 300);
                
            }, 100);
            
            // Show success message
            showToast('✏️ Question loaded for editing! Form is populated at the top.', 'toast-ai');
            
            console.log('Edit function completed successfully');
        }
        
        // Cancel editing mode
        function cancelEdit() {
            editingId = null;
            
            // Remove visual editing mode from form
            const formCard = document.querySelector('.card:has(#question-form)');
            if (formCard) {
                formCard.classList.remove('form-editing');
            }
            
            // Reset form
            document.getElementById('question-form').reset();
            document.getElementById('question-rich').innerHTML = '';
            document.getElementById('explanation').innerHTML = '';
            document.getElementById('discussion').innerHTML = '';
            document.getElementById('options-container').innerHTML = '';
            
            // Add default options
            addOption();
            addOption();
            
            // Reset submit button
            const submitButton = document.querySelector('#question-form button[type="submit"]');
            submitButton.textContent = 'Save Question';
            submitButton.classList.remove('btn-update');
            
            // Hide cancel button
            const cancelButton = document.getElementById('cancel-edit-btn');
            if (cancelButton) {
                cancelButton.style.display = 'none';
            }
            
            // Hide image preview
            imagePreview.style.display = 'none';
            
            showToast('Edit mode cancelled', 'toast');
        }

        // Delete a question from the Question Bank
        function deleteQuestion(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                // Convert ID to number if it's a string (from HTML template)
                const numericId = typeof id === 'string' ? parseInt(id, 10) : id;
                questionBank = questionBank.filter(q => q.id !== numericId);
                saveQuestionBank();
                renderQuestions();
                updateStats();
                showToast('Question deleted!', 'toast');
            }
        }

        // --- Option Management ---
        // Create a new option input HTML element
        function createOptionHtml(value = '', placeholder = '') {
            const div = document.createElement('div');
            div.classList.add('option-input');
            div.innerHTML = `
                <input type="radio" name="correct-answer">
                <input type="text" placeholder="${placeholder}" value="${value}" required>
                <button type="button" class="btn btn-danger" onclick="removeOption(this)">×</button>
            `;
            return div;
        }

        // Add a new option to the options container
        function addOption() {
            const optionsContainer = document.getElementById('options-container');
            const optionCount = optionsContainer.children.length;
            if (optionCount >= 7) {
                showToast('You can only have up to 7 options (A-G).', 'toast-error');
                return;
            }
            const placeholder = `Option ${String.fromCharCode(65 + optionCount)}`;
            const newOption = createOptionHtml('', placeholder);
            optionsContainer.appendChild(newOption);
        }

        // Remove an option from the options container
        function removeOption(button) {
            const optionsContainer = document.getElementById('options-container');
            if (optionsContainer.children.length > 2) {
                button.closest('.option-input').remove();
            } else {
                showToast('You must have at least 2 options.', 'toast-error');
            }
        }
        
        // --- Stats and Export ---
        // Update the dashboard stats
        function updateStats() {
            document.getElementById('total-questions').textContent = questionBank.length;
            document.getElementById('ai-questions').textContent = questionBank.filter(q => q.source === 'ai').length;
            document.getElementById('internal-medicine').textContent = questionBank.filter(q => q.subject === 'Internal Medicine').length;
        }

        // Generate timestamp for filenames
        function getTimestampForFilename() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        // Export the question bank to Excel
        function exportToExcel() {
            const dataToExport = [
                ["Export Date:", new Date().toLocaleString()],
                [],
                ["Exam Name", "Subject", "Topic", "Question", "Option A", "Option B", "Option C", "Option D", "Correct Answer", "Explanation", "Discussion", "Source", "Created At", "Updated At"]
            ];
            
            questionBank.forEach(q => {
                const row = [
                    q.examName,
                    q.subject,
                    q.topic,
                    q.question,
                    q.options[0],
                    q.options[1],
                    q.options[2] || '',
                    q.options[3] || '',
                    q.correctAnswer,
                    q.explanation.replace(/<[^>]*>?/gm, ''),
                    q.discussion ? q.discussion.replace(/<[^>]*>?/gm, '') : '',
                    q.source,
                    q.createdAt,
                    q.updatedAt
                ];
                dataToExport.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Questions");
            const timestamp = getTimestampForFilename();
            XLSX.writeFile(wb, `Medical_Questions_${timestamp}.xlsx`);
            showToast('Exported to Excel!', 'toast-export');
        }

        // Export the question bank to PDF with professional formatting
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Define colors and styling
            const primaryColor = [44, 111, 187]; // Blue
            const secondaryColor = [142, 68, 173]; // Purple
            const textColor = [51, 51, 51]; // Dark gray
            const lightGray = [245, 245, 245];
            const borderColor = [220, 220, 220];
            
            // Header section
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(0, 0, 210, 25, 'F');
            
            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text("📊 Medical Exam Question Bank", 15, 12);
            
            // Subtitle
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generated on ${new Date().toLocaleString()}`, 15, 19);
            
            // Statistics section
            doc.setTextColor(textColor[0], textColor[1], textColor[2]);
            doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
            doc.rect(15, 30, 180, 20, 'F');
            doc.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
            doc.rect(15, 30, 180, 20, 'S');
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text("📈 Statistics", 20, 38);
            
            doc.setFont('helvetica', 'normal');
            const totalQuestions = questionBank.length;
            const aiQuestions = questionBank.filter(q => q.source === 'ai').length;
            const subjects = [...new Set(questionBank.map(q => q.subject))].length;
            
            doc.text(`Total Questions: ${totalQuestions} | AI Generated: ${aiQuestions} | Subjects: ${subjects}`, 20, 45);
            
            let y = 60;
            const pageHeight = 297; // A4 height in mm
            const marginBottom = 20;
            
            questionBank.forEach((q, index) => {
                // Check if we need a new page
                if (y > pageHeight - marginBottom - 60) {
                    doc.addPage();
                    y = 20;
                    
                    // Add header to new page
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(0, 0, 210, 15, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text("Medical Question Bank - Continued", 15, 10);
                    y = 25;
                }
                
                // Question number and metadata box
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.setFillColor(245, 248, 255);
                doc.rect(15, y, 180, 8, 'F');
                doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.rect(15, y, 180, 8, 'S');
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`Question ${index + 1}`, 20, y + 5);
                
                // Subject and topic info
                doc.setFont('helvetica', 'normal');
                const metaInfo = `${q.subject} - ${q.topic} | ${q.examName}`;
                doc.text(metaInfo, 120, y + 5);
                
                y += 12;
                
                // Question text
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                
                const questionLines = doc.splitTextToSize(`Q: ${q.question}`, 175);
                doc.text(questionLines, 20, y);
                y += questionLines.length * 5 + 3;
                
                // Options
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                
                q.options.forEach((option, i) => {
                    const optionLetter = String.fromCharCode(65 + i);
                    const isCorrect = q.correctAnswer === optionLetter;
                    
                    if (isCorrect) {
                        // Highlight correct answer
                        doc.setFillColor(230, 255, 230);
                        doc.rect(20, y - 3, 170, 6, 'F');
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 128, 0);
                    } else {
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    }
                    
                    const optionLines = doc.splitTextToSize(`${optionLetter}. ${option}`, 165);
                    doc.text(optionLines, 25, y);
                    y += optionLines.length * 4 + 1;
                });
                
                y += 3;
                
                // Explanation section
                if (q.explanation) {
                    // Check if we need a new page for explanation
                    const estimatedExplanationHeight = 40; // Estimated height
                    if (y + estimatedExplanationHeight > pageHeight - marginBottom) {
                        doc.addPage();
                        y = 20;
                        
                        // Add header to new page
                        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                        doc.rect(0, 0, 210, 15, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text("Medical Question Bank - Continued", 15, 10);
                        y = 25;
                    }
                    
                    doc.setFillColor(255, 248, 220);
                    const explanationHeaderHeight = 6;
                    doc.rect(20, y - 2, 170, explanationHeaderHeight, 'F');
                    doc.setDrawColor(255, 193, 7);
                    doc.rect(20, y - 2, 170, explanationHeaderHeight, 'S');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(133, 100, 4);
                    doc.setFontSize(9);
                    doc.text("💡 Explanation:", 25, y + 2);
                    y += 8;
                    
                    // Process explanation with simple, reliable text formatting
                    if (q.explanation) {
                        // Check if we need a new page for explanation
                        if (y > pageHeight - marginBottom - 30) {
                            doc.addPage();
                            y = 20;
                            
                            // Add header to new page
                            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                            doc.rect(0, 0, 210, 15, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text("Medical Question Bank - Continued", 15, 10);
                            y = 25;
                        }
                        
                        // Explanation header
                        doc.setFillColor(255, 248, 220);
                        doc.rect(20, y - 2, 170, 6, 'F');
                        doc.setDrawColor(255, 193, 7);
                        doc.rect(20, y - 2, 170, 6, 'S');
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(133, 100, 4);
                        doc.setFontSize(9);
                        doc.text("💡 Explanation:", 25, y + 2);
                        y += 8;
                        
                        // Clean explanation text
                        let explanationText = q.explanation
                            .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '$1')
                            .replace(/<b[^>]*>(.*?)<\/b>/gi, '$1')
                            .replace(/<em[^>]*>(.*?)<\/em>/gi, '$1')
                            .replace(/<i[^>]*>(.*?)<\/i>/gi, '$1')
                            .replace(/<u[^>]*>(.*?)<\/u>/gi, '$1')
                            .replace(/<br\s*\/?>/gi, '\n')
                            .replace(/<\/p>/gi, '\n')
                            .replace(/<p[^>]*>/gi, '')
                            .replace(/<li[^>]*>/gi, '• ')
                            .replace(/<\/li>/gi, '\n')
                            .replace(/<ul[^>]*>/gi, '')
                            .replace(/<\/ul>/gi, '')
                            .replace(/<ol[^>]*>/gi, '')
                            .replace(/<\/ol>/gi, '')
                            .replace(/<h[1-6][^>]*>(.*?)<\/h[1-6]>/gi, '$1')
                            .replace(/<[^>]*>/g, '')
                            .replace(/\n\s*\n/g, '\n')
                            .trim();
                        
                        // Split into manageable chunks
                        const explanationLines = explanationText.split('\n');
                        
                        for (let line of explanationLines) {
                            if (!line.trim()) {
                                y += 3;
                                continue;
                            }
                            
                            // Check page break for each line
                            if (y > pageHeight - marginBottom - 10) {
                                doc.addPage();
                                y = 20;
                                
                                // Add header to new page
                                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                                doc.rect(0, 0, 210, 15, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(12);
                                doc.setFont('helvetica', 'bold');
                                doc.text("Medical Question Bank - Continued", 15, 10);
                                y = 25;
                            }
                            
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                            doc.setFontSize(9);
                            
                            const wrappedLines = doc.splitTextToSize(line.trim(), 165);
                            wrappedLines.forEach((wrappedLine, index) => {
                                if (y > pageHeight - marginBottom - 5) {
                                    doc.addPage();
                                    y = 20;
                                    
                                    // Add header to new page
                                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                                    doc.rect(0, 0, 210, 15, 'F');
                                    doc.setTextColor(255, 255, 255);
                                    doc.setFontSize(12);
                                    doc.setFont('helvetica', 'bold');
                                    doc.text("Medical Question Bank - Continued", 15, 10);
                                    y = 25;
                                    
                                    doc.setFont('helvetica', 'normal');
                                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                                    doc.setFontSize(9);
                                }
                                
                                doc.text(wrappedLine, 25, y);
                                y += 4;
                            });
                        }
                        
                        y += 5;
                    }
                    
                    y += 5;
                }
                
                // Discussion section
                if (q.discussion) {
                    // Check if we need a new page for discussion
                    const estimatedDiscussionHeight = 60; // Estimated height
                    if (y + estimatedDiscussionHeight > pageHeight - marginBottom) {
                        doc.addPage();
                        y = 20;
                        
                        // Add header to new page
                        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                        doc.rect(0, 0, 210, 15, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text("Medical Question Bank - Continued", 15, 10);
                        y = 25;
                    }
                    
                    doc.setFillColor(240, 235, 255);
                    const discussionHeaderHeight = 6;
                    doc.rect(20, y - 2, 170, discussionHeaderHeight, 'F');
                    doc.setDrawColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.rect(20, y - 2, 170, discussionHeaderHeight, 'S');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.setFontSize(9);
                    doc.text("💬 Discussion:", 25, y + 2);
                    y += 8;
                    
                    // Process discussion with simple, reliable text formatting
                    if (q.discussion) {
                        // Check if we need a new page for discussion
                        if (y > pageHeight - marginBottom - 30) {
                            doc.addPage();
                            y = 20;
                            
                            // Add header to new page
                            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                            doc.rect(0, 0, 210, 15, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text("Medical Question Bank - Continued", 15, 10);
                            y = 25;
                        }
                        
                        // Discussion header
                        doc.setFillColor(240, 235, 255);
                        doc.rect(20, y - 2, 170, 6, 'F');
                        doc.setDrawColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                        doc.rect(20, y - 2, 170, 6, 'S');
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                        doc.setFontSize(9);
                        doc.text("💬 Discussion:", 25, y + 2);
                        y += 8;
                        
                        // Clean discussion text - NO TRUNCATION
                        let discussionText = q.discussion
                            .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '$1')
                            .replace(/<b[^>]*>(.*?)<\/b>/gi, '$1')
                            .replace(/<em[^>]*>(.*?)<\/em>/gi, '$1')
                            .replace(/<i[^>]*>(.*?)<\/i>/gi, '$1')
                            .replace(/<u[^>]*>(.*?)<\/u>/gi, '$1')
                            .replace(/<br\s*\/?>/gi, '\n')
                            .replace(/<\/p>/gi, '\n')
                            .replace(/<p[^>]*>/gi, '')
                            .replace(/<li[^>]*>/gi, '• ')
                            .replace(/<\/li>/gi, '\n')
                            .replace(/<ul[^>]*>/gi, '')
                            .replace(/<\/ul>/gi, '')
                            .replace(/<ol[^>]*>/gi, '')
                            .replace(/<\/ol>/gi, '')
                            .replace(/<h[1-6][^>]*>(.*?)<\/h[1-6]>/gi, '$1')
                            .replace(/<[^>]*>/g, '')
                            .replace(/\n\s*\n/g, '\n')
                            .trim();
                        
                        // Split into manageable chunks
                        const discussionLines = discussionText.split('\n');
                        
                        for (let line of discussionLines) {
                            if (!line.trim()) {
                                y += 3;
                                continue;
                            }
                            
                            // Check page break for each line
                            if (y > pageHeight - marginBottom - 10) {
                                doc.addPage();
                                y = 20;
                                
                                // Add header to new page
                                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                                doc.rect(0, 0, 210, 15, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(12);
                                doc.setFont('helvetica', 'bold');
                                doc.text("Medical Question Bank - Continued", 15, 10);
                                y = 25;
                            }
                            
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                            doc.setFontSize(9);
                            
                            const wrappedLines = doc.splitTextToSize(line.trim(), 165);
                            wrappedLines.forEach((wrappedLine, index) => {
                                if (y > pageHeight - marginBottom - 5) {
                                    doc.addPage();
                                    y = 20;
                                    
                                    // Add header to new page
                                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                                    doc.rect(0, 0, 210, 15, 'F');
                                    doc.setTextColor(255, 255, 255);
                                    doc.setFontSize(12);
                                    doc.setFont('helvetica', 'bold');
                                    doc.text("Medical Question Bank - Continued", 15, 10);
                                    y = 25;
                                    
                                    doc.setFont('helvetica', 'normal');
                                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                                    doc.setFontSize(9);
                                }
                                
                                doc.text(wrappedLine, 25, y);
                                y += 4;
                            });
                        }
                        
                        y += 5;
                    }
                    
                    y += 5;
                }
                
                // Footer info
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(128, 128, 128);
                const footerText = `Created: ${q.createdAt || 'N/A'} | Source: ${q.source === 'ai' ? '🤖 AI Generated' : '✏️ Manual'} | Creator: ${q.createdBy || 'Unknown'}`;
                doc.text(footerText, 20, y);
                y += 8;
                
                // Separator line
                if (index < questionBank.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.line(15, y, 195, y);
                    y += 8;
                }
            });
            
            // Add page numbers
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${totalPages}`, 180, 290);
            }
            
            const timestamp = getTimestampForFilename();
            doc.save(`Medical_Questions_${timestamp}.pdf`);
            showToast('Enhanced PDF exported successfully!', 'toast-export');
        }

        // Export the question bank to Markdown with clean formatting
        function exportToMarkdown() {
            let markdownContent = `# 📊 Medical Exam Question Bank\n\n`;
            markdownContent += `**Generated on:** ${new Date().toLocaleString()}\n\n`;
            
            const totalQuestions = questionBank.length;
            const aiQuestions = questionBank.filter(q => q.source === 'ai').length;
            const subjects = [...new Set(questionBank.map(q => q.subject))];
            
            markdownContent += `## 📈 Statistics\n\n`;
            markdownContent += `- **Total Questions:** ${totalQuestions}\n`;
            markdownContent += `- **AI Generated:** ${aiQuestions}\n`;
            markdownContent += `- **Manual Questions:** ${totalQuestions - aiQuestions}\n`;
            markdownContent += `- **Subjects:** ${subjects.join(', ')}\n\n`;
            markdownContent += `---\n\n`;
            
            questionBank.forEach((q, index) => {
                const isAiGenerated = q.source === 'ai';
                const correctAnswer = q.correctAnswer;
                
                markdownContent += `## Question ${index + 1}\n\n`;
                markdownContent += `**Exam:** ${q.examName} | **Subject:** ${q.subject} | **Topic:** ${q.topic}\n`;
                if (isAiGenerated) {
                    markdownContent += `🤖 *AI Generated Question*\n`;
                }
                markdownContent += `\n`;
                
                // Clean and format question text
                const questionText = cleanHtmlForMarkdown(q.question);
                markdownContent += `**Question:**\n${questionText}\n\n`;
                
                // Options
                markdownContent += `**Options:**\n`;
                q.options.forEach((option, i) => {
                    const optionLetter = String.fromCharCode(65 + i);
                    const isCorrect = correctAnswer === optionLetter;
                    const cleanOption = cleanHtmlForMarkdown(option);
                    markdownContent += `${optionLetter}. ${cleanOption}${isCorrect ? ' ✅' : ''}\n`;
                });
                markdownContent += `\n`;
                
                // Correct Answer
                markdownContent += `**Correct Answer:** ${correctAnswer}\n\n`;
                
                // Explanation
                if (q.explanation) {
                    markdownContent += `### 💡 Explanation\n\n`;
                    const cleanExplanation = cleanHtmlForMarkdown(q.explanation);
                    markdownContent += `${cleanExplanation}\n\n`;
                }
                
                // Discussion
                if (q.discussion) {
                    markdownContent += `### 💬 Discussion\n\n`;
                    const cleanDiscussion = cleanHtmlForMarkdown(q.discussion);
                    markdownContent += `${cleanDiscussion}\n\n`;
                }
                
                // Metadata
                markdownContent += `---\n`;
                markdownContent += `*Created: ${q.createdAt || 'N/A'} | Source: ${isAiGenerated ? '🤖 AI Generated' : '✏️ Manual'} | Last Updated: ${q.updatedAt || 'N/A'}*\n\n`;
            });
            
            // Create and download the file
            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = getTimestampForFilename();
            a.download = `Medical_Questions_${timestamp}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Exported to Markdown successfully!', 'toast-export');
        }
        
        // Helper function to clean HTML content for Markdown
        function cleanHtmlForMarkdown(htmlContent) {
            if (!htmlContent) return '';
            
            return htmlContent
                // Convert HTML formatting to Markdown
                .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                .replace(/<u[^>]*>(.*?)<\/u>/gi, '_$1_')
                
                // Convert lists
                .replace(/<ul[^>]*>/gi, '')
                .replace(/<\/ul>/gi, '')
                .replace(/<ol[^>]*>/gi, '')
                .replace(/<\/ol>/gi, '')
                .replace(/<li[^>]*>/gi, '- ')
                .replace(/<\/li>/gi, '\n')
                
                // Convert line breaks and paragraphs
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<\/p>/gi, '\n\n')
                .replace(/<p[^>]*>/gi, '')
                
                // Convert headers
                .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n')
                .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n')
                .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n')
                .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n')
                .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n')
                .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n')
                
                // Remove any remaining HTML tags
                .replace(/<[^>]*>/g, '')
                
                // Clean up extra whitespace
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                .replace(/^\s+|\s+$/g, '')
                .trim();
        }

        // Export question bank as JSON file
        function exportToJSON() {
            const dataStr = JSON.stringify(questionBank, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = getTimestampForFilename();
            a.download = `question_bank_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Exported as JSON!', 'toast-export');
        }

        // Import question bank from JSON file
        const importJsonInput = document.getElementById('import-json-input');
        importJsonInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        questionBank = imported;
                        saveQuestionBank();
                        renderQuestions();
                        updateStats();
                        showToast('Imported from JSON!', 'toast-export');
                    } else {
                        showToast('Invalid JSON format.', 'toast-error');
                    }
                } catch (err) {
                    showToast('Failed to import JSON.', 'toast-error');
                }
                importJsonInput.value = '';
            };
            reader.readAsText(file);
        });
        // --- Search and Filter ---
        // Search/filter questions
        function searchQuestions() {
            renderQuestions();
        }

        // --- Form Submission ---
        // Handle add/update question form submission
        questionForm.addEventListener('submit', function(e) {
            e.preventDefault();
    
            const questionText = document.getElementById('question-rich').innerHTML;
            const optionsInputs = document.querySelectorAll('#options-container input[type="text"]');
            const options = Array.from(optionsInputs).map(input => input.value);
    
            const correctRadio = document.querySelector('input[name="correct-answer"]:checked');
            if (!correctRadio) {
                showToast('Please select a correct answer.', 'toast-error');
                return;
            }
            const correctIndex = Array.from(optionsInputs).findIndex(input => input === correctRadio.nextElementSibling);
            const correctAnswer = String.fromCharCode(65 + correctIndex);

            const explanation = document.getElementById('explanation').innerHTML;
            const discussion = document.getElementById('discussion').innerHTML;
            const now = new Date().toLocaleString();

            const questionData = {
                examName: document.getElementById('exam-name').value,
                subject: document.getElementById('subject').value,
                topic: document.getElementById('topic').value,
                question: questionText,
                options: options,
                correctAnswer: correctAnswer,
                explanation: explanation,
                discussion: discussion,
                source: 'manual',
                image: imagePreview.style.display === 'block' ? imagePreview.src : null,
                createdBy: getCurrentUserInfo()
            };

            if (editingId !== null) {
                const questionIndex = questionBank.findIndex(q => q.id === editingId);
                questionBank[questionIndex] = { ...questionBank[questionIndex], ...questionData, updatedAt: now };
                editingId = null;
                
                // Remove visual editing mode from form
                const formCard = document.querySelector('.card:has(#question-form)');
                if (formCard) {
                    formCard.classList.remove('form-editing');
                }
                
                // Reset submit button
                const submitButton = document.querySelector('#question-form button[type="submit"]');
                submitButton.textContent = 'Save Question';
                submitButton.classList.remove('btn-update');
                
                // Hide cancel button
                const cancelButton = document.getElementById('cancel-edit-btn');
                if (cancelButton) {
                    cancelButton.style.display = 'none';
                }
                
                showToast('Question updated successfully!', 'toast');
            } else {
                questionData.id = Date.now();
                questionData.createdAt = now;
                questionData.updatedAt = now;
                questionBank.unshift(questionData);
                showToast('Question saved successfully!', 'toast');
            }

            saveQuestionBank();
            renderQuestions();
            updateStats();
            questionForm.reset();
            document.getElementById('question-rich').innerHTML = '';
            document.getElementById('explanation').innerHTML = '';
            document.getElementById('discussion').innerHTML = '';
            imagePreview.style.display = 'none';
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            editingId = null;
            
            // Remove visual editing mode from form
            const formCard = document.querySelector('.card:has(#question-form)');
            if (formCard) {
                formCard.classList.remove('form-editing');
            }
            
            // Reset submit button
            const submitButton = document.querySelector('#question-form button[type="submit"]');
            submitButton.textContent = 'Save Question';
            submitButton.classList.remove('btn-update');
            
            // Hide cancel button
            const cancelButton = document.getElementById('cancel-edit-btn');
            if (cancelButton) {
                cancelButton.style.display = 'none';
            }
            
            document.getElementById('explanation').innerHTML = '';
            document.getElementById('discussion').innerHTML = '';
            document.getElementById('question-rich').innerHTML = '';
            document.getElementById('options-container').innerHTML = '';
            
            // Add default options
            addOption();
            addOption();
            
            imagePreview.style.display = 'none';
        });

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });

        function formatText(command) {
            document.execCommand(command, false, null);
        }

        // For question rich text
        function formatQuestionText(command) {
            document.execCommand(command, false, null);
        }

        function insertQuestionImage() {
            document.getElementById('question-image-insert').click();
        }

        document.getElementById('question-image-insert').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = `<img src="${e.target.result}" style="max-width: 100%; display: block; margin-top: 10px;">`;
                    insertHtmlAtCursorInQuestion(img);
                }
                reader.readAsDataURL(file);
            }
        });

        function insertHtmlAtCursorInQuestion(html) {
            let sel, range;
            const questionDiv = document.getElementById('question-rich');
            questionDiv.focus();
            if (window.getSelection) {
                sel = window.getSelection();
                if (sel.getRangeAt && sel.rangeCount) {
                    range = sel.getRangeAt(0);
                    const el = document.createElement('div');
                    el.innerHTML = html;
                    const frag = document.createDocumentFragment();
                    let node, lastNode;
                    while ((node = el.firstChild)) {
                        lastNode = frag.appendChild(node);
                    }
                    range.deleteContents();
                    range.insertNode(frag);
                }
            }
        }

        function handleExplanationImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = `<img src="${e.target.result}" style="max-width: 100%; display: block; margin-top: 10px;">`;
                    document.getElementById('explanation').insertAdjacentHTML('beforeend', img);
                }
                reader.readAsDataURL(file);
            }
        }

        // Discussion formatting functions
        function formatDiscussion(command) {
            const discussionEditor = document.getElementById('discussion');
            discussionEditor.focus();
            document.execCommand(command, false, null);
        }

        function insertDiscussionImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = `<img src="${e.target.result}" style="max-width: 100%; display: block; margin: 10px 0; border-radius: 4px;">`;
                        insertHtmlAtCursorInDiscussion(img);
                    }
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function insertHtmlAtCursorInDiscussion(html) {
            const discussionDiv = document.getElementById('discussion');
            discussionDiv.focus();
            if (window.getSelection) {
                const sel = window.getSelection();
                if (sel.getRangeAt && sel.rangeCount) {
                    const range = sel.getRangeAt(0);
                    const el = document.createElement('div');
                    el.innerHTML = html;
                    const frag = document.createDocumentFragment();
                    let node, lastNode;
                    while ((node = el.firstChild)) {
                        lastNode = frag.appendChild(node);
                    }
                    range.deleteContents();
                    range.insertNode(frag);
                }
            }
        }

        // --- AI Generation ---
        // Generate AI explanation for a question
        document.getElementById('generate-explanation-btn').addEventListener('click', async function() {
            // Gather question and options from the rich text editor
            const questionRich = document.getElementById('question-rich').innerHTML.trim();
            const question = questionRich || document.getElementById('question')?.value?.trim() || '';
            const optionsNodes = document.querySelectorAll('#options-container .option-input');
            let options = [];
            let correctIndex = -1;
            optionsNodes.forEach((node, idx) => {
                const text = node.querySelector('input[type="text"]').value.trim();
                options.push(text);
                if (node.querySelector('input[type="radio"]').checked) correctIndex = idx;
            });
            if (!question || options.length < 2 || correctIndex === -1) {
                showToast('Please enter the question, at least two options, and select the correct answer.', 'toast-error');
                return;
            }
            
            // Use the same API configuration as the main AI generation section
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('ai-model').value;
            
            if (!apiKey) {
                showToast('Please enter your API key in the AI Question Generation section first.', 'toast-error');
                return;
            }
            
            // Compose prompt
            let prompt = `You are an expert medical educator. Provide an evidence-based explanation for the following question.\n\nFirst, give a brief introduction about the main topic of the question.\nThen, explain why the correct option is correct, citing evidence-based medicine (EBM) or clinical guidelines if possible.\nThen, for each incorrect option, explain one by one why it is incorrect, also based on EBM.\n\nQuestion: ${question}\nOptions:`;
            options.forEach((opt, i) => {
                prompt += `\n${String.fromCharCode(65+i)}. ${opt}`;
            });
            prompt += `\n\nCorrect Answer: ${String.fromCharCode(65+correctIndex)}\n\nFormat the response as follows:\nIntroduction: ...\nCorrect Option (${String.fromCharCode(65+correctIndex)}): ...\nIncorrect Options:\nA: ...\nB: ...\nC: ...\nD: ...\n(Include only the relevant options)\nAll explanations must be based on evidence-based medicine.`;
            
            // Prepare API call using the same structure as main AI generation
            const messages = [
                { role: 'system', content: 'You are a medical education assistant. Give concise, clear explanations.' },
                { role: 'user', content: prompt }
            ];
            
            // Show loading
            const explanationDiv = document.getElementById('explanation');
            explanationDiv.innerHTML = '<em>Generating explanation with AI...</em>';
            
            try {
                let apiUrl, requestBody, headers;

                // Configure API call based on selected model (same as main generation)
                if (model.startsWith('gpt')) {
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    requestBody = JSON.stringify({
                        model: model,
                        messages: messages
                    });
                } else if (model.startsWith('gemini')) {
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    requestBody = JSON.stringify({
                        "contents": [{
                            "role": "user",
                            "parts": [{ "text": prompt }]
                        }],
                        "safetySettings": [
                            { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                        ]
                    });
                } else if (model.startsWith('deepseek')) {
                    apiUrl = 'https://api.deepseek.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    requestBody = JSON.stringify({
                        model: model,
                        messages: messages,
                        stream: false
                    });
                } else {
                    showToast('Selected model is not supported.', 'toast-error');
                    return;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                let content;
                
                // Parse response based on model (same as main generation)
                if (model.startsWith('gpt') || model.startsWith('deepseek')) {
                    content = data.choices[0].message.content;
                } else if (model.startsWith('gemini')) {
                    content = data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Unsupported model response format.');
                }
                
                explanationDiv.innerHTML = content.replace(/\n/g, '<br>');
                showToast('AI explanation generated!', 'toast-ai');
            } catch (err) {
                explanationDiv.innerHTML = '';
                console.error('Explanation generation error:', err);
                showToast('Failed to generate explanation. Check your API key and connection.', 'toast-error');
            }
        });

        // Generate AI discussion for a question (manual form)
        document.getElementById('generate-discussion-btn').addEventListener('click', async function() {
            // Use the same API configuration as the main AI generation section
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('ai-model').value;
            
            if (!apiKey) {
                showToast('Please enter your API key in the AI Question Generation section first.', 'toast-error');
                return;
            }

            // Gather question data from the rich text editor
            const question = document.getElementById('question-rich').innerHTML.trim() || document.getElementById('question')?.value?.trim() || '';
            const optionsNodes = document.querySelectorAll('#options-container .option-input');
            let options = [];
            let correctIndex = -1;
            
            optionsNodes.forEach((node, idx) => {
                const text = node.querySelector('input[type="text"]').value.trim();
                options.push(text);
                if (node.querySelector('input[type="radio"]').checked) correctIndex = idx;
            });

            if (!question || options.length < 2 || correctIndex === -1) {
                showToast('Please enter the question, at least two options, and select the correct answer.', 'toast-error');
                return;
            }

            const subject = document.getElementById('subject').value;
            const topic = document.getElementById('topic').value;

            // Create comprehensive discussion prompt
            let prompt = `You are an expert medical educator. Create a comprehensive, well-structured discussion about the following medical question that includes:

1. **Introduction**: Brief overview of the main topic/condition
2. **Pathophysiology**: Underlying mechanisms (if applicable)
3. **Clinical Presentation**: Signs, symptoms, and diagnostic findings
4. **Differential Diagnosis**: Other conditions to consider
5. **Management**: Treatment approaches and guidelines
6. **Key Learning Points**: Important takeaways for medical students
7. **Clinical Pearls**: Practical tips for clinical practice

Make the discussion educational, evidence-based, and suitable for medical students. Use proper medical terminology but explain complex concepts clearly.

**Question**: ${question}
**Subject**: ${subject}
**Topic**: ${topic}
**Options**:`;
            
            options.forEach((opt, i) => {
                prompt += `\n${String.fromCharCode(65+i)}. ${opt}`;
            });
            
            prompt += `\n**Correct Answer**: ${String.fromCharCode(65 + correctIndex)}\n\nProvide the comprehensive discussion:`;

            // Show loading
            const loadingEl = document.getElementById('discussion-loading');
            const generateBtn = document.getElementById('generate-discussion-btn');
            
            loadingEl.classList.add('show');
            generateBtn.disabled = true;

            try {
                let apiUrl, requestBody, headers;

                // Configure API call based on selected model (same as main generation)
                if (model.startsWith('gpt')) {
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    requestBody = JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: 'You are a medical education expert. Create well-structured, comprehensive discussions that help medical students learn effectively.' },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 2000,
                        temperature: 0.7
                    });
                } else if (model.startsWith('gemini')) {
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    headers = { 'Content-Type': 'application/json' };
                    requestBody = JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { maxOutputTokens: 2000, temperature: 0.7 },
                        "safetySettings": [
                            { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                            { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                        ]
                    });
                } else if (model.startsWith('deepseek')) {
                    apiUrl = 'https://api.deepseek.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    requestBody = JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: 'You are a medical education expert. Create well-structured, comprehensive discussions that help medical students learn effectively.' },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 2000,
                        temperature: 0.7
                    });
                } else {
                    showToast('Selected model is not supported.', 'toast-error');
                    loadingEl.classList.remove('show');
                    generateBtn.disabled = false;
                    return;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                let content;
                
                // Parse response based on model (same as main generation)
                if (model.startsWith('gpt') || model.startsWith('deepseek')) {
                    content = data.choices[0].message.content;
                } else if (model.startsWith('gemini')) {
                    content = data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Unsupported model response format.');
                }
                
                // Clean the content to remove unwanted AI introductory phrases
                content = cleanAiDiscussionContent(content);
                
                // Format the content with proper HTML structure
                content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                content = content.replace(/\n\n/g, '</p><p>');
                content = content.replace(/\n/g, '<br>');
                content = `<p>${content}</p>`;

                document.getElementById('discussion').innerHTML = content;
                showToast('AI discussion generated successfully!', 'toast-ai');
                
            } catch (error) {
                console.error('Discussion generation error:', error);
                showToast('Failed to generate discussion. Please check your API key and try again.', 'toast-error');
            } finally {
                loadingEl.classList.remove('show');
                generateBtn.disabled = false;
            }
        });

        document.getElementById('import-excel-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                // Expect columns: Question, Options, Answer, Subject, Exam, Topic, Source
                let imported = 0;
                const now = new Date().toLocaleString();
                const creatorInfo = getCurrentUserInfo();
                
                json.forEach(row => {
                    if (row.Question && row.Answer) {
                        questionBank.push({
                            id: Date.now() + imported, // Ensure unique IDs
                            question: row.Question,
                            options: row.Options ? row.Options.split(';') : [],
                            correctAnswer: row.Answer,
                            subject: row.Subject || '',
                            examName: row.Exam || '',
                            topic: row.Topic || '',
                            explanation: row.Explanation || '',
                            source: row.Source || 'imported',
                            image: null,
                            createdAt: now,
                            updatedAt: now,
                            createdBy: creatorInfo
                        });
                        imported++;
                    }
                });
                const storageKey = getUserStorageKey('medicalQuestionBank');
                localStorage.setItem(storageKey, JSON.stringify(questionBank));
                if (typeof renderQuestions === 'function') renderQuestions();
                showToast(imported + ' questions imported from Excel!', 'toast-export');
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        });
        
        // --- Authentication Functions ---
        let currentUser = null;

        function initAuth() {
            // Check for user session
            const userSession = localStorage.getItem('userSession');
            if (userSession) {
                try {
                    currentUser = JSON.parse(userSession);
                    displayUserProfile(currentUser);
                } catch (error) {
                    console.error('Error parsing user session:', error);
                    localStorage.removeItem('userSession');
                    showLoginSection();
                }
            } else {
                showLoginSection();
            }

            // Add logout event listener
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }

        function displayUserProfile(user) {
            const userProfileSection = document.getElementById('userProfileSection');
            const guestNotice = document.getElementById('guestNotice');
            const loginSection = document.getElementById('loginSection');
            
            // Hide other sections
            guestNotice.style.display = 'none';
            loginSection.style.display = 'none';
            
            // Show user profile
            userProfileSection.style.display = 'flex';
            
            if (user.isGuest) {
                guestNotice.style.display = 'flex';
                userProfileSection.style.display = 'none';
            } else {
                // Get user initials
                const initials = user.displayName 
                    ? user.displayName.split(' ').map(n => n[0]).join('').toUpperCase()
                    : user.email[0].toUpperCase();
                
                // Update user icon
                const userIcon = document.getElementById('userInitials');
                const profileAvatar = document.getElementById('profileAvatar');
                const modalAvatar = document.getElementById('modalAvatar');
                
                userIcon.textContent = initials;
                profileAvatar.textContent = initials;
                modalAvatar.textContent = initials;
                
                // Update profile info in dropdown
                document.getElementById('profileName').textContent = user.displayName || 'User';
                document.getElementById('profileEmail').textContent = user.email;
                
                // Update profile info in modal
                document.getElementById('modalName').textContent = user.displayName || 'User';
                document.getElementById('modalEmail').textContent = user.email;
                document.getElementById('modalDisplayName').textContent = user.displayName || 'Not set';
                document.getElementById('modalUserEmail').textContent = user.email;
                
                // Set join date
                const joinDate = user.metadata && user.metadata.creationTime 
                    ? new Date(user.metadata.creationTime).toLocaleDateString()
                    : 'Unknown';
                document.getElementById('modalJoinDate').textContent = joinDate;
                
                // Set provider info
                const providerData = user.providerData && user.providerData[0];
                let providerName = 'Email';
                if (providerData) {
                    if (providerData.providerId === 'google.com') providerName = 'Google';
                    else if (providerData.providerId === 'github.com') providerName = 'GitHub';
                    else if (providerData.providerId === 'facebook.com') providerName = 'Facebook';
                }
                document.getElementById('modalProvider').textContent = providerName;
                
                // Set questions count
                const userQuestions = questions.filter(q => q.createdBy === user.email || q.createdBy === user.displayName);
                document.getElementById('modalQuestionsCount').textContent = userQuestions.length;
                
                // Setup dropdown and modal functionality
                setupUserIconHandlers();
            }

            // Load user-specific data
            updateQuestionBankForUser();
        }

        function showLoginSection() {
            const userProfileSection = document.getElementById('userProfileSection');
            const guestNotice = document.getElementById('guestNotice');
            const loginSection = document.getElementById('loginSection');
            
            userProfileSection.style.display = 'none';
            guestNotice.style.display = 'none';
            loginSection.style.display = 'flex';
        }

        function logout() {
            if (confirm('Are you sure you want to logout? Your questions will remain saved locally.')) {
                localStorage.removeItem('userSession');
                currentUser = null;
                showToast('Logged out successfully', 'success');
                showLoginSection();
            }
        }

        function setupUserIconHandlers() {
            const userIcon = document.getElementById('userIcon');
            const profileDropdown = document.getElementById('profileDropdown');
            const profileModal = document.getElementById('profileModal');
            const viewProfileBtn = document.getElementById('viewProfileBtn');
            const modalClose = document.getElementById('modalClose');
            
            // Toggle dropdown when clicking user icon
            userIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = profileDropdown.classList.contains('show');
                
                if (isVisible) {
                    profileDropdown.classList.remove('show');
                    userIcon.classList.remove('active');
                } else {
                    profileDropdown.classList.add('show');
                    userIcon.classList.add('active');
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!userIcon.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                    userIcon.classList.remove('active');
                }
            });
            
            // Show profile modal when clicking "View Profile"
            viewProfileBtn.addEventListener('click', function() {
                profileDropdown.classList.remove('show');
                userIcon.classList.remove('active');
                profileModal.classList.add('show');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            });
            
            // Close modal
            function closeModal() {
                profileModal.classList.remove('show');
                document.body.style.overflow = ''; // Restore scroll
            }
            
            modalClose.addEventListener('click', closeModal);
            
            // Close modal when clicking outside
            profileModal.addEventListener('click', function(e) {
                if (e.target === profileModal) {
                    closeModal();
                }
            });
            
            // Close modal with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && profileModal.classList.contains('show')) {
                    closeModal();
                }
            });
        }

        // Get current user information for question creation
        function getCurrentUserInfo() {
            if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                const user = firebase.auth().currentUser;
                return user.displayName || user.email?.split('@')[0] || 'User';
            }
            
            // Fallback for guest users or when Firebase is not available
            return 'Anonymous User';
        }

        function getUserStorageKey(key) {
            // Create user-specific storage keys for logged-in users
            if (currentUser && !currentUser.isGuest) {
                return `${key}_${currentUser.uid}`;
            }
            return key; // Use default key for guests and fallback
        }

        function loadUserQuestionBank() {
            // Load user-specific question bank
            const storageKey = getUserStorageKey('medicalQuestionBank');
            const stored = localStorage.getItem(storageKey);
            return stored ? JSON.parse(stored) : [];
        }

        function updateQuestionBankForUser() {
            // Reload question bank for current user
            questionBank = loadUserQuestionBank();
            renderQuestions();
            updateStats();
        }
        
        // Initialize the application
        function initApp() {
            // Initialize authentication
            initAuth();
            
            // Load existing question bank from localStorage
            questionBank = loadUserQuestionBank();
            
            if (openAiApiKey) {
                apiKeyInput.value = openAiApiKey;
                updateApiStatus('API key loaded.', 'success');
            }
            
            if (openAiModel) {
                aiModelSelect.value = openAiModel;
            }
            
            $('.searchable-select').select2({
                placeholder: "Select an option",
                allowClear: true
            });
            
            $('#filter-subject').on('change', renderQuestions);
            $('#filter-exam').on('change', renderQuestions);
            $('#filter-source').on('change', renderQuestions);
            
            document.querySelectorAll('.ai-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.ai-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            imageUploadInput.addEventListener('change', handleExplanationImageUpload);
            
            renderQuestions();
            updateStats();
            
            addOption();
            addOption();
        }
        
        function updateApiStatus(message, type = 'info') {
            apiStatus.textContent = message;
            apiStatus.style.background = type === 'success' ? '#e6f7e6' : (type === 'error' ? '#fde6e6' : '#f0f0f0');
            apiStatus.style.color = type === 'success' ? '#218838' : (type === 'error' ? '#e63737' : '#333');
        }

        // --- AI Generation ---
        // Generate AI question based on user inputs and AI model
        async function generateQuestion() {
            const aiTopic = document.getElementById('ai-topic').value;
            const aiSubject = document.getElementById('ai-subject').value;
            const aiExamName = document.getElementById('ai-exam-name').value || 'Medical Exam';
            const aiContext = document.getElementById('ai-context').value;
            const model = document.getElementById('ai-model').value;
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                showToast('Please enter your API key.', 'toast-error');
                return;
            }

            if (!aiTopic || !aiSubject) {
                showToast('Please enter a subject and topic for AI generation.', 'toast-error');
                return;
            }

            aiLoading.style.display = 'block';
            aiResult.style.display = 'none';

            let promptText = `Generate a critical, hard-difficulty multiple-choice question for the "${aiExamName}" on the subject of "${aiSubject}" about the topic "${aiTopic}". The question must have exactly four options (A, B, C, D).`;

            if (aiContext) {
                promptText += `\n\nAdditional context or requirements: ${aiContext}`;
            }

            promptText += `\n\nThe explanation must contain a short introduction, a detailed explanation of the correct option, and a detailed breakdown of why each of the other three options is incorrect. The final response must be a single JSON object with the following structure, with NO additional text or markdown outside of the JSON block:
                {
                    "question": "[The question text]",
                    "options": {
                        "A": "[Option A text]",
                        "B": "[Option B text]",
                        "C": "[Option C text]",
                        "D": "[Option D text]"
                    },
                    "correctAnswer": "[The letter of the correct option, e.g., 'B']",
                    "explanation": {
                        "introduction": "[Short introduction]",
                        "correctExplanation": "[Detailed explanation for the correct option]",
                        "incorrectExplanations": {
                            "A": "[Reason why Option A is incorrect]",
                            "B": "[Reason why Option B is incorrect]",
                            "C": "[Reason why Option C is incorrect]",
                            "D": "[Reason why Option D is incorrect]"
                        }
                    }
                }`;

            const messages = [
                { role: "system", content: "You are a specialized medical education assistant. Your task is to generate realistic, critical, and hard-difficulty medical exam questions. Ensure your responses are formatted exactly as a valid JSON object." },
                { role: "user", content: promptText }
            ];

            if (aiFileContent) {
                messages.push({ role: "user", content: `Use the following content from a document or image as additional context: ${aiFileContent}` });
            }

            let apiUrl, requestBody, headers;

            // Configure API call based on selected model
            if (model.startsWith('gpt')) {
                apiUrl = 'https://api.openai.com/v1/chat/completions';
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                };
                requestBody = JSON.stringify({
                    model: model,
                    messages: messages,
                    response_format: { type: "json_object" }
                });
            } else if (model.startsWith('gemini')) {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                requestBody = JSON.stringify({
                    "contents": [{
                        "role": "user",
                        "parts": [{ "text": promptText }]
                    }],
                    "generationConfig": {
                        "response_mime_type": "application/json"
                    },
                    "safetySettings": [
                        { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                        { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                        { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                        { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                    ]
                });
            } else if (model.startsWith('deepseek')) {
                apiUrl = 'https://api.deepseek.com/v1/chat/completions';
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                };
                requestBody = JSON.stringify({
                    model: model,
                    messages: messages,
                    stream: false
                });
            } else {
                showToast('Selected model is not supported.', 'toast-error');
                aiLoading.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message);
                }

                const data = await response.json();
                const aiResponse = parseAiResponse(data, model);

                const explanationString = `<strong>Introduction:</strong> ${aiResponse.explanation.introduction}<br><br>` +
                    `<strong>Correct Answer (${aiResponse.correctAnswer}):</strong> ${aiResponse.explanation.correctExplanation}<br><br>` +
                    `<strong>Why other options are incorrect:</strong><br>` +
                    `<ul>` +
                    Object.keys(aiResponse.explanation.incorrectExplanations).map(key => {
                        return `<li><strong>Option ${key}:</strong> ${aiResponse.explanation.incorrectExplanations[key]}</li>`;
                    }).join('') +
                    `</ul>`;

                currentAiQuestion = {
                    question: aiResponse.question,
                    options: Object.values(aiResponse.options),
                    correctAnswer: aiResponse.correctAnswer,
                    explanation: explanationString,
                    source: 'ai',
                    examName: aiExamName,
                    subject: aiSubject,
                    topic: aiTopic,
                    image: null
                };
                
                displayAiQuestion(currentAiQuestion);
                showToast('AI question generated successfully!', 'toast-ai');

                // Automatically generate discussion for AI question
                await generateAiDiscussion(currentAiQuestion);

            } catch (error) {
                console.error('Error generating AI question:', error);
                showToast(`AI generation failed: ${error.message}`, 'toast-error');
            } finally {
                aiLoading.style.display = 'none';
            }
        }

        function parseAiResponse(data, model) {
            let content;
            if (model.startsWith('gpt') || model.startsWith('deepseek')) {
                content = data.choices[0].message.content;
            } else if (model.startsWith('gemini')) {
                content = data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Unsupported model response format.');
            }
            return JSON.parse(content);
        }

        // Generate AI discussion for the current AI question
        async function generateAiDiscussion(questionData) {
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('ai-model').value;
            
            if (!apiKey) return;

            try {
                // Create comprehensive discussion prompt
                let prompt = `You are an expert medical educator. Create a comprehensive, well-structured discussion about the following medical question that includes:

1. **Introduction**: Brief overview of the main topic/condition
2. **Pathophysiology**: Underlying mechanisms (if applicable)
3. **Clinical Presentation**: Signs, symptoms, and diagnostic findings
4. **Differential Diagnosis**: Other conditions to consider
5. **Management**: Treatment approaches and guidelines
6. **Key Learning Points**: Important takeaways for medical students
7. **Clinical Pearls**: Practical tips for clinical practice

Make the discussion educational, evidence-based, and suitable for medical students preparing for ${questionData.examName}. Use proper medical terminology but explain complex concepts clearly.

**Question**: ${questionData.question}
**Subject**: ${questionData.subject}
**Topic**: ${questionData.topic}
**Options**:
${questionData.options.map((opt, i) => `${String.fromCharCode(65+i)}. ${opt}`).join('\n')}
**Correct Answer**: ${questionData.correctAnswer}

Provide the comprehensive discussion formatted with proper headings and structure:`;

                const messages = [
                    { role: 'system', content: 'You are a medical education expert. Create well-structured, comprehensive discussions that help medical students learn effectively.' },
                    { role: 'user', content: prompt }
                ];

                let apiUrl, requestBody, headers;

                // Configure API call based on selected model
                if (model.startsWith('gpt')) {
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    requestBody = JSON.stringify({
                        model: model,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7
                    });
                } else if (model.startsWith('gemini')) {
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    headers = { 'Content-Type': 'application/json' };
                    requestBody = JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { maxOutputTokens: 2000, temperature: 0.7 }
                    });
                } else if (model.startsWith('deepseek')) {
                    apiUrl = 'https://api.deepseek.com/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    requestBody = JSON.stringify({
                        model: model,
                        messages: messages,
                        max_tokens: 2000,
                        temperature: 0.7
                    });
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });

                if (!response.ok) {
                    throw new Error('Discussion generation failed');
                }

                const data = await response.json();
                let content;

                if (model.startsWith('gpt') || model.startsWith('deepseek')) {
                    content = data.choices[0].message.content;
                } else if (model.startsWith('gemini')) {
                    content = data.candidates[0].content.parts[0].text;
                }

                // Clean the content to remove unwanted AI introductory phrases
                content = cleanAiDiscussionContent(content);

                // Format the content with proper HTML structure
                content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                content = content.replace(/\n\n/g, '</p><p>');
                content = content.replace(/\n/g, '<br>');
                content = `<p>${content}</p>`;

                // Store the discussion with the current AI question
                currentAiQuestion.discussion = content;
                
                // Display the discussion
                displayAiDiscussion(content);
                
            } catch (error) {
                console.error('Discussion generation error:', error);
                // Silently fail for discussion generation - don't show error toast
            }
        }

        // Display AI-generated discussion
        function displayAiDiscussion(discussionContent) {
            document.getElementById('ai-discussion-text').innerHTML = discussionContent;
            document.getElementById('ai-discussion-result').style.display = 'block';
        }
        
        // Clean AI discussion content by removing unwanted introductory paragraphs
        function cleanAiDiscussionContent(content) {
            if (!content) return content;
            
            // List of common unwanted introductory phrases that AI models tend to use
            const unwantedIntros = [
                /^Of course[.,!]?\s*/i,
                /^Certainly[.,!]?\s*/i,
                /^Here is a comprehensive.*?(?:discussion|analysis).*?(?:\.|:)\s*/i,
                /^I'll provide a comprehensive.*?(?:discussion|analysis).*?(?:\.|:)\s*/i,
                /^Let me provide.*?(?:discussion|analysis).*?(?:\.|:)\s*/i,
                /^This is a comprehensive.*?(?:discussion|analysis).*?(?:\.|:)\s*/i,
                /^Below is a comprehensive.*?(?:discussion|analysis).*?(?:\.|:)\s*/i,
                /^Here's a detailed.*?(?:discussion|analysis).*?(?:\.|:)\s*/i,
                /^The following is.*?(?:discussion|analysis).*?(?:\.|:)\s*/i
            ];
            
            // List of common unwanted concluding phrases that AI models tend to use
            const unwantedConclusions = [
                /By understanding.*?(?:medical students|students|learners|healthcare professionals).*?(?:can|will).*?(?:enhance|improve|develop|strengthen).*?(?:skills|knowledge|understanding|competence|acumen).*?[.,!]?\s*$/i,
                /This (?:case|discussion|analysis).*?(?:highlights|demonstrates|illustrates|emphasizes).*?(?:importance|need|significance).*?[.,!]?\s*$/i,
                /(?:Medical students|Students|Healthcare professionals).*?(?:should|must|need to|ought to).*?(?:understand|recognize|appreciate|be aware of).*?[.,!]?\s*$/i,
                /Understanding.*?(?:is|are).*?(?:crucial|essential|important|vital|critical).*?(?:for|in).*?(?:medical practice|clinical practice|healthcare|patient care).*?[.,!]?\s*$/i,
                /This knowledge.*?(?:is|will be).*?(?:essential|important|crucial|valuable).*?(?:for|in).*?(?:clinical|medical|healthcare).*?[.,!]?\s*$/i,
                /In conclusion.*?(?:understanding|knowledge|awareness).*?(?:of|about).*?(?:is|are).*?(?:important|essential|crucial).*?[.,!]?\s*$/i,
                /(?:Proper|Effective|Timely|Early).*?(?:recognition|diagnosis|management|treatment).*?(?:is|are).*?(?:key|essential|crucial|important).*?(?:to|for).*?(?:successful|optimal|effective).*?[.,!]?\s*$/i,
                /These (?:concepts|principles|guidelines|strategies).*?(?:are|will be).*?(?:fundamental|essential|important|valuable).*?(?:for|in).*?(?:medical education|clinical practice|patient care).*?[.,!]?\s*$/i
            ];
            
            // Remove unwanted introductory sentences
            let cleanedContent = content;
            unwantedIntros.forEach(pattern => {
                cleanedContent = cleanedContent.replace(pattern, '');
            });
            
            // Remove unwanted concluding sentences
            unwantedConclusions.forEach(pattern => {
                cleanedContent = cleanedContent.replace(pattern, '');
            });
            
            // Also remove any leading paragraph that starts with these patterns
            const paragraphs = cleanedContent.split(/\n\s*\n/);
            if (paragraphs.length > 0) {
                const firstParagraph = paragraphs[0].trim();
                const shouldRemoveFirstParagraph = unwantedIntros.some(pattern => 
                    pattern.test(firstParagraph)
                );
                
                if (shouldRemoveFirstParagraph) {
                    paragraphs.shift(); // Remove the first paragraph
                    cleanedContent = paragraphs.join('\n\n');
                }
            }
            
            // Also remove any ending paragraph that matches concluding patterns
            if (paragraphs.length > 0) {
                const lastParagraph = paragraphs[paragraphs.length - 1].trim();
                const shouldRemoveLastParagraph = unwantedConclusions.some(pattern => 
                    pattern.test(lastParagraph)
                );
                
                if (shouldRemoveLastParagraph) {
                    paragraphs.pop(); // Remove the last paragraph
                    cleanedContent = paragraphs.join('\n\n');
                }
            }
            
            return cleanedContent.trim();
        }

        // Regenerate AI discussion
        async function regenerateAiDiscussion() {
            if (currentAiQuestion) {
                document.getElementById('ai-discussion-result').style.display = 'none';
                await generateAiDiscussion(currentAiQuestion);
            }
        }

        // Use AI discussion - copy to manual form
        function useAiDiscussion() {
            if (currentAiQuestion && currentAiQuestion.discussion) {
                document.getElementById('discussion').innerHTML = currentAiQuestion.discussion;
                showToast('Discussion copied to manual form!', 'toast-ai');
            }
        }

        function regenerateQuestion() {
            generateQuestion();
        }

        async function processAiFile() {
            const fileInput = document.getElementById('ai-file');
            const file = fileInput.files[0];
            if (!file) {
                showToast('Please select a file to process.', 'toast-error');
                return;
            }

            showToast('Processing file...', 'toast-ai');
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    if (file.type.startsWith('image/')) {
                        const base64Image = e.target.result;
                        aiFileContent = `The user has provided an image. Use this image as context for the question. The image is encoded in Base64: ${base64Image}`;
                    } else {
                        const textContent = e.target.result;
                        aiFileContent = `The user has provided the following text document for context: ${textContent}`;
                    }
                    showToast('File processed successfully!', 'toast-ai');
                };
                reader.readAsDataURL(file);
            } catch (error) {
                showToast('Failed to process file. Please try again.', 'toast-error');
                console.error('File processing error:', error);
            }
        }

        async function processAiUrl() {
            const urlInput = document.getElementById('ai-url');
            const url = urlInput.value.trim();
            if (!url) {
                showToast('Please enter a URL.', 'toast-error');
                return;
            }

            showToast('Fetching and summarizing URL content...', 'toast-ai');
            aiFileContent = `The user has provided the following URL for context: ${url}. The content of the page is relevant to the question generation.`;
            showToast('URL processed successfully! Content will be used as context.', 'toast-ai');
            urlInput.value = '';
        }
        
        function displayAiQuestion(question) {
            aiResult.style.display = 'block';
            let htmlContent = `
                <p><strong>Question:</strong> ${question.question}</p>
                <p><strong>Options:</strong></p>
                <ul>
                    ${question.options.map((opt, index) => `<li>${String.fromCharCode(65 + index)}. ${opt}</li>`).join('')}
                </ul>
                <p><strong>Correct Answer:</strong> ${question.correctAnswer}</p>
                <p><strong>Explanation:</strong><br>${question.explanation}</p>
            `;
            aiQuestionText.innerHTML = htmlContent;
        }

        function useAiQuestion() {
            if (!currentAiQuestion) {
                showToast('No AI question to save.', 'toast-error');
                return;
            }

            const now = new Date().toLocaleString();
            const newQuestion = {
                id: Date.now(),
                examName: currentAiQuestion.examName,
                subject: currentAiQuestion.subject,
                topic: currentAiQuestion.topic,
                question: currentAiQuestion.question,
                options: currentAiQuestion.options,
                correctAnswer: currentAiQuestion.correctAnswer,
                explanation: currentAiQuestion.explanation,
                discussion: currentAiQuestion.discussion || '',
                source: 'ai',
                image: null,
                createdAt: now,
                updatedAt: now,
                createdBy: getCurrentUserInfo()
            };

            questionBank.unshift(newQuestion);
            saveQuestionBank();
            renderQuestions();
            updateStats();

            aiResult.style.display = 'none';
            document.getElementById('ai-discussion-result').style.display = 'none';
            document.getElementById('ai-topic').value = '';
            currentAiQuestion = null;
            aiFileContent = null;
            document.getElementById('ai-context').value = '';
            document.getElementById('ai-file').value = '';
            showToast('AI question saved to question bank!', 'toast');
        }

        // --- Dropdown Functions ---
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const button = document.getElementById(dropdownId + 'Btn');
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu.id !== dropdownId) {
                    menu.classList.remove('show');
                }
            });
            
            document.querySelectorAll('.dropdown-btn').forEach(btn => {
                if (btn.id !== dropdownId + 'Btn') {
                    btn.classList.remove('active');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('show');
            button.classList.toggle('active');
        }

        function closeDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const button = document.getElementById(dropdownId + 'Btn');
            
            dropdown.classList.remove('show');
            button.classList.remove('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const dropdowns = document.querySelectorAll('.dropdown-container');
            
            dropdowns.forEach(container => {
                if (!container.contains(event.target)) {
                    const dropdown = container.querySelector('.dropdown-menu');
                    const button = container.querySelector('.dropdown-btn');
                    
                    dropdown.classList.remove('show');
                    button.classList.remove('active');
                }
            });
        });

        // Close dropdowns on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
                document.querySelectorAll('.dropdown-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        });

        // --- Initialization ---
        // Initialize the app on page load
        initApp();
    </script>
    
    <!-- Footer -->
    <footer class="app-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-brand">
                        <h3><i class="fas fa-brain"></i> QBank Generator</h3>
                        <p>Medical Question Bank Management System</p>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Navigation</h4>
                    <ul class="footer-links">
                        <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                        <li><a href="auth.html"><i class="fas fa-sign-in-alt"></i> Authentication</a></li>
                        <li><a href="#question-form"><i class="fas fa-plus"></i> Add Question</a></li>
                        <li><a href="#questions-list"><i class="fas fa-list"></i> Question Bank</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Features</h4>
                    <ul class="footer-links">
                        <li><span><i class="fas fa-robot"></i> AI Generation</span></li>
                        <li><span><i class="fas fa-file-export"></i> Export (PDF, Excel, JSON)</span></li>
                        <li><span><i class="fas fa-file-import"></i> Import Questions</span></li>
                        <li><span><i class="fas fa-search"></i> Advanced Filtering</span></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Platform</h4>
                    <div class="social-links">
                        <a href="https://qbgenerator.aimedipedia.com" target="_blank" title="Live Site">
                            <i class="fas fa-globe"></i>
                        </a>
                        <a href="https://github.com/yourusername/medical-question-bank-generator" target="_blank" title="GitHub">
                            <i class="fab fa-github"></i>
                        </a>
                        <a href="index.html" title="Landing Page">
                            <i class="fas fa-info-circle"></i>
                        </a>
                    </div>
                    <p class="footer-domain">qbgenerator.aimedipedia.com</p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="footer-info">
                    <p>&copy; 2025 Medical Question Bank Generator by <strong>AI Medipedia</strong></p>
                    <p class="footer-subtitle">Professional medical education platform</p>
                </div>
                <div class="footer-badges">
                    <span class="badge">Offline Ready</span>
                    <span class="badge">User Private</span>
                    <span class="badge">Export Anywhere</span>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>